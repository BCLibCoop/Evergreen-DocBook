<?xml version='1.0' encoding='UTF-8'?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude"
	    xmlns:xl="http://www.w3.org/1999/xlink" version="5.0" xml:id="adminmisc">
	<info>
		
	<title>Server Operations and Maintenance</title>
		<abstract>
			<para>This chapter deals with basic server operations such as starting and stopping Evergreen as well wall security, backing up and troubleshooting Evergreen.</para>
        	</abstract>
	</info>    
	<section xml:id="startingopensrf">
		<title>Starting, Stopping and Restarting</title>
		<para>Occasionally, you may need to restart Evergreen. It is imperative that you understand the basic 
		commands to stop and start the Evergreen server. You can start and stop Evergreen from the command line of 
		the server using the <filename >osrf_ctl.sh</filename> script located in the 
		<filename class="directory">openils/bin</filename> directory.</para>   
		<note><para>The osrf_ctl.sh script must be run as the <emphasis>opensrf</emphasis> user.</para></note>
		<para>To view help on <filename>osrf_ctl.sh</filename> and get all of its options, 
		run:</para>
		<screen>osrf_ctl.sh -h</screen>
		<para>To start Evergreen, run:</para>
		<screen>osrf_ctl.sh -l -a start_all</screen>
		<para>The -l flag is used to indicate that Evergreen is configured to use <emphasis>localhost</emphasis> as 
		the host. If you have configured opensrf.xml to use your real hostname, do not use the -l flag. The -a 
		option is required and indicates the <emphasis>action</emphasis> of the command. In this case 
		<emphasis>start_all</emphasis>.    
		</para>	
		<note>
			<para>If you receive the error message bash: osrf_ctl.sh: 
			command not found, then your environment variable PATH does not include the 
			<filename class="directory">/openils/bin</filename> directory. 
			You can set it using the following command:</para>
			<screen>export PATH=$PATH:/openils/bin</screen>
			<para>If you receive the error message Can't locate OpenSRF/System.pm in @INC … BEGIN 
			failed–compilation aborted, then your environment variable <emphasis>PERL5LIB</emphasis> does not 
			include the <filename class="directory">/openils/lib/perl5</filename> directory.  You can set it 
			using the following command:</para>
			<screen>export PERL5LIB=$PERL5LIB:/openils/lib/perl5</screen>
		</note>		
		<para>It is also possible to start a specific service. For example:</para>
		<screen>osrf_ctl.sh -l -a start_router</screen>
		<para>will only start the router service.</para>
		<caution>
			<para>If you decide to start each service individually, you need to start them in a specific order 
			for Evergreen to start correctly. Run the commands in this exact order:</para>
			<screen>osrf_ctl.sh -l -a start_router</screen>
			<screen>osrf_ctl.sh -l -a start_perl</screen>
			<screen>osrf_ctl.sh -l -a start_c</screen>
		</caution>	
		<para>After starting or restarting Evergreen, it is also necessary to restart the Apache web server for the 
		OPAC to work correctly.</para>  
		<para>To stop Evergreen, run:</para>
		<screen>osrf_ctl.sh -l -a stop_all</screen>
		<para>As with starting, you can choose to stop one service</para>
		<para>To restart Evergreen, run:</para>
		<screen>osrf_ctl.sh -l -a restart_all</screen>
	</section>
	<section xml:id="backingup">
		<title>Backing Up</title>
		<para>Backing up your system files and data is a critical task for server and database administrators. 
		Having a strategy for backing up and recovery could be the difference between a minor annoyance for users and
		a a complete catastrophe.</para>   
		<simplesect>
			<title>Backing up the Evergreen Database</title>
			<para>Most of the critical data for an Evergreen system – patrons, bibliographic records, holdings, 
			transactions, bills – is stored in the PostgreSQL database. You can therefore use normal PostgreSQL 
			backup procedures to backup this data. For example, the simplest method of backing up the Evergreen
			database is to use the pg_dump command to create a live backup of the database without having to 
			interrupt any Evergreen services as follows:</para>
			<screen># pg_dump -U [username] -h [hostname] -f [output-file] [database-name]</screen> 
			<screen>pg_dump -U evergreen -h localhost -f evergreen_db.backup evergreen</screen>
			<para>To restore the backed up database into a new database, create a new database using the 
			template0 database template and the UTF8 encoding, and run the psql command, specifying the new 
			database as your target:</para>
			<screen>createdb -T template0 -E UTF8 -U evergreen -h localhost new_evergreen</screen>
			<screen>psql -U evergreen -h localhost -f evergreen_db.backup new_evergreen</screen>
			<note>
				<para>This method of backup is only suitable for small Evergreen instances. Larger sites 
				should consider implementing continuous archiving (also known as “log shipping”) to provide 
				more granular backups with lower system overhead. More information on backing up PostgreSQL 
				databases can be found in the official PostgreSQL documentation.</para>
			</note>
		</simplesect>
		<simplesect>
			<title>Backing up Evergreen Files</title>
			<para>When you deploy Evergreen, you will probably customize many aspects of your system including 
			the system configuration files, Apache configuration files, OPAC and Staff Client. In order to 
			protect your investment of time, you should carefully consider the best approach to backing up 
			files.</para>
			<para>There are a number of ways of tackling this problem. You could create a script that regularly 
			creates a time-stamped tarball of all of these files and copies it to a remote server - but that 
			would build up over time to hundreds of files. You could use rsync to ensure that the files of 
			interest are regularly updated on a remote server - but then you would lose track of the changes to 
			the files, should you make a change that introduces a problem down the road.</para>
			<para>Perhaps one of the best options is to use a version control system like Bazaar, git, 
			Subversion, or CVS to regularly push updates of the files you care about to a repository on a 
			remote server. This gives you the advantage of quickly being able to run through the history of the 
			changes you made, with a commenting system that reminds you why each change was made, combined with 
			remote storage of the pertinent files in case of disaster on site. In addition, your team can create 
			local copies of the repository and test their own changes in isolation from the production 
			system. Using a version control system also helps to recover system customizations after an 
			upgrade.</para>
		</simplesect>
		<simplesect>
			<title>Full System Backup</title>
			<para>A full system backup archives every file on the file system. Some basic methods require you 
			to shut down most system processes; other methods can use mirrored RAID setups or SAN storage to 
			take “snapshot” backups of your full system while the system continues to run. The subject of how 
			to implement full system backups is beyond the scope of this documentation.</para>
		</simplesect>
	</section>
	<section xml:id="security">
		<title>Security</title>
		<para>As with an ILS and resource accessible from the world wide web careful consideration needs to be 
		given to the security of your Evergreen servers and database. While it is impossible to cover all aspects 
		of security, it is important to take several precautions when setting up production Evergreen site.</para>
		<orderedlist>
			<listitem>
				<para>Change the Evergreen <emphasis>Admin</emphasis> password and keep it secure. The 
				default Admin password is known by anyone who has installed Evergreen. It is not a secret 
				and needs to be changed by the Administrator. It should also only be shared by those who 
				need the highest level access to Evergreen.</para>
			</listitem>
			<listitem>
				<para>Create strong passwords using a combination of numerical and alphabetical characters 
				for all of the Administrative passwords used by Evergreen including the Evergreen 
				postgresql user, opensrf Linux account, and Admin evergreen users, and of course, any
				superusers on your server.</para>     
			</listitem>
			<listitem>
				<para>Open ports in the firewall with Caution - It is necessary to open some ports to the 
				server such as port 80 for http and  443 for ssl, and it can be helpful to open ports for 
				remote access to the database or staff client. It is also critical for an administrator to 
				understand the concepts of network security and take precautions to not allow the server to 
				be vulnerable to the outside world. 
				</para>
			</listitem>
			<listitem>
				<para>Use permissions and permission groups wisely - it is important to understand the 
				purpose of the permissions and to only give users the level of access that they require.
				</para> 
			</listitem>
					</orderedlist>	
	</section>
	<section xml:id="logfiles">
		<title>Managing Log Files</title>
		<para>Evergreen comes with a sophisticated logging system, but it is important to manage the OpenSRF and Evergreen logs. This section will provide a couple of log management techniques 
		and tools.</para> 	
		<simplesect>
			<title>Using the Log Rotate Utility to Manage Log Size</title> 
			 <para>Fortunately, this is not a new problem for Unix administrators, and there are a number of ways of keeping your logs under control. On Debian and Ubuntu, for example, 
			the logrotate utility controls when old log files are compressed and a new log file is started. logrotate runs once a day and checks all log files that it knows about to see if a 
			threshold of time or size has been reached and rotates the log files if a threshold condition has been met.</para>
			<para>To teach logrotate to rotate Evergreen logs on a weekly basis, or if they are > 50MB in size, create a new file <filename>/etc/logrotate.d/evergreen</filename> with the 
			following contents: </para>
			<screen>compress</screen>
			<screen>/openils/var/log/*.log {</screen>
			<screen> # keep the last 4 archived log files along with the current log file</screen>
	 		<screen> # log log.1.gz log.2.gz log.3.gz log.4.gz</screen>
	 		<screen> # and delete the oldest log file (what would have been log.5.gz)</screen>
	  		<screen>rotate 5</screen>
	  		<screen># if the log file is > 50MB in size, rotate it immediately</screen>
	 		<screen> size 50M</screen>
	 		<screen> # for those logs that don't grow fast, rotate them weekly anyway</screen>
			<screen>  weekly</screen>
	 		<screen>}</screen>
		</simplesect>
		<simplesect>
			<title>Changing Logging Level for Evergreen</title>
			<para>Change the Log Levels in your config files. Changing the level of logging will help 
			narrow down errors.</para> 
			<tip>
				<para>A high logging level is not wise to do in a production environment since  it 
				will produce vastly larger log files and thus reduce server performance.</para>
			</tip>
			<para>Change logging levels by editing the configuration file 
			<filename>/openils/conf/opensrf_core.xml</filename></para>
			<para>you will want to search for lines containing &lt;loglevel&gt;.</para>
			<para> the default setting for loglevel is 3 which will log <emphasis>errors</emphasis>, 
			<emphasis>warnings</emphasis> and <emphasis>information</emphasis>.</para>
			<para>The next level is 4 which is for debugging and provides additional information 
			helpful for the debugging process.</para>
			<para>Thus, lines with:</para>
			<screen>&lt;loglevel&gt;3&lt;/loglevel&gt;</screen>
			<para>Should be changed to:</para>
			<screen>&lt;loglevel&gt;4&lt;/loglevel&gt;</screen>
			<para>to allow debugging level logging</para>
			<para>Other logging levels include <emphasis>0</emphasis> for no logging, 
			<emphasis>1</emphasis> for logging errors and <emphasis>2</emphasis> for logging warnings 
			and errors.</para>
		</simplesect>
	</section>
</chapter>
