<?xml version="1.0" encoding="UTF-8"?>
<chapter xml:id="ServersideInstallation" xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xl="http://www.w3.org/1999/xlink">
	<info>
		<title>Server-side Installation of Evergreen Software</title>
		<abstract>
			<para>This section describes installation of the Evergreen server-side software and its associated components. Installation, configuration, testing and verification of the software is straightforward if you follow some simple directions.</para>
		</abstract>
	</info>
	<section xml:id="serversideinstallation-overview">
		<title>Overview</title>
		<para>Installing, configuring and testing the Evergreen server-side software is straightforward with the current stable software release. See <xref linkend="serversideinstallation-all"/> for instructions tailored to installing on some particular distributions of the <systemitem class="osname">Linux</systemitem> operating system. Earlier software distributions are described in <xref linkend="serversideinstallation-previousversions"/>.</para>
		<para>The current version of the Evergreen server-side software runs as a native application on any of several well-known <systemitem class="osname">Linux</systemitem> distributions (e.g., <systemitem class="osname">Ubuntu</systemitem> and <systemitem class="osname">Debian</systemitem>). It does not currently run as a native application on the <systemitem class="osname">Microsoft Windows</systemitem> operating system (e.g., <systemitem class="osname">WindowsXP</systemitem>, <systemitem class="osname">WindowsXP Professional</systemitem>, <systemitem class="osname">Windows7</systemitem>), but the software can still be installed and run on <systemitem class="osname">Windows</systemitem> via a so-called <emphasis>virtualized</emphasis> Unix-guest Operating System (using, for example, <application>VirtualBox</application>, or <application>VMware</application>, or <application>VirtualPC</application> to emulate a <systemitem class="osname">Linux</systemitem> environment). It can also be installed to run on other <systemitem class="osname">Linux</systemitem> systems via virtualized environments (using, for example, <application>VirtualBox</application> or <application>VMware</application>). More information on virtualized environments can be found in <xref linkend="serversideinstallation-virtual"/>.</para>
		<para>Installation of some sub-components of the Evergreen server-side software is mentioned only in abbreviated form in this section. More detailed information is available in <xref linkend="serversideinstallation-postgresql"/> and <xref linkend="serversideinstallation-apache"/>.</para>
		<para>Finally, installation of the Evergreen Staff Client software is reviewed in <xref linkend="serversideinstallation-staffclient"/>. </para>
		<section>
			<title>Evergreen Software Dependencies</title>
			<para>The Evergreen server-side software has dependencies on particular versions of certain major software sub-components. Successful installation of Evergreen software requires that software versions agree with those listed here:</para>
			<table>
				<title>Evergreen Software Dependencies</title>
				<tgroup align="left" cols="3" colsep="1" rowsep="1">
					<thead>
						<row>
							<entry>Evergreen</entry>
							<entry>OpenSRF</entry>
							<entry>PostgreSQL</entry>
						</row>
					</thead>
					<tbody>
						<row>
							<entry>1.6.x</entry>
							<entry>1.2</entry>
							<entry>8.2 / 8.3</entry>
						</row>
						<row>
							<entry>1.4.x</entry>
							<entry>1.0</entry>
							<entry>8.1 / 8.2</entry>
						</row>
						<row>
							<entry>1.2.x</entry>
							<entry>0.9</entry>
							<entry>8.1 / 8.2</entry>
						</row>
					</tbody>
				</tgroup>
			</table>
		</section>
		<section>
			<title>Current Stable Software Release</title>
			<para>The current stable release of Evergreen is version <emphasis><emphasis role="bold">1.6.0.7</emphasis></emphasis>. Instructions for installing, configuring and testing that version on the <systemitem class="osname">Ubuntu</systemitem> or <systemitem class="osname">Debian</systemitem> <systemitem class="osname">Linux</systemitem> systems are found in <xref linkend="serversideinstallation-ubuntudebian"/>.</para>
			<para>This release of Evergreen software is dependent on the Open Service Request Framework (OpenSRF). The current stable release of OpenSRF is version <emphasis><emphasis role="bold">1.2.2</emphasis></emphasis>. Instructions for installing, configuring and testing that version are found in <xref linkend="serversideinstallation-opensrf"/>.</para>
		</section>
		<section>
			<title>Previous Software Releases</title>
			<para>Earlier releases of Evergreen are also available. Instructions for installing, configuring and testing earlier versions are found in <xref linkend="serversideinstallation-previousversions"/>.</para>
			<para>The next most recent previous release of Evergreen is version <emphasis><emphasis role="bold">1.4.0.6</emphasis></emphasis>. Instructions for installing, configuring and testing that version are found in <xref linkend="serversideinstallation-evergreen-previous"/>.</para>
			<para>The accompanying previous release of OpenSRF is version <emphasis><emphasis role="bold">1.0.x</emphasis></emphasis>. Instructions for installing, configuring and testing that version are found in <xref linkend="serversideinstallation-opensrf-previous"/>.</para>
		</section>
	</section>
	<section xml:id="serversideinstallation-all">
		<title>Installing Server-Side Software</title>
		<para>This section describes the installation of the major components of Evergreen server-side software.</para>
		<para>As far as possible, you should perform the following steps in the exact order given since the success of many steps relies on the successful completion of earlier steps. You should make backup copies of files and environments when you are instructed to do so. In the event of installation problems those copies can allow you to back out of a step gracefully and resume the installation from a known state. See <xref linkend="adminmisc-backingup"/> for further information.</para>
		<para>Of course, after you successfully complete and test the entire Evergreen installation you should take a final snapshot backup of your system(s). This can be the first in the series of regularly scheduled system backups that you should probably also begin.</para>
		<section xml:id="serversideinstallation-opensrf">
			<title>Installing OpenSRF 1.2.x On <systemitem class="osname">Ubuntu</systemitem> or <systemitem class="osname">Debian</systemitem></title>
			<para>This section describes the installation of the latest version of the Open Service Request Framework (OpenSRF), a major component of the Evergreen server-side software, on <systemitem class="osname">Ubuntu</systemitem> or <systemitem class="osname">Debian</systemitem> systems. Evergreen software is integrated with and depends on the OpenSRF software system.</para>
			<para>Follow the steps outlined here and run the specified tests to ensure that OpenSRF is properly installed and configured. Do not continue with any further Evergreen installation steps until you have verified that OpenSRF has been successfully installed.</para>
			<note>
				<para>The following steps have been tested on the x86 (32-bit) and x86-64 (64-bit) platforms. OpenSRF 1.2.2 has been tested on <systemitem class="osname">Debian Etch (4.0)</systemitem>, <systemitem class="osname">Debian Lenny</systemitem>, <systemitem class="osname">Ubuntu Hardy Heron (8.04)</systemitem>, and <systemitem class="osname">Ubuntu Intrepid Ibex (8.10)</systemitem>.</para>
				<para>In the following instructions, you are asked to perform certain steps as either the <systemitem class="username">root</systemitem> user, the <systemitem class="username">opensrf</systemitem> user, or the <systemitem class="username">postgres</systemitem> user.</para>
				<itemizedlist>
					<listitem><systemitem class="osname">Debian</systemitem> -- To become the <systemitem class="username">root</systemitem> user, issue the command <command>su -</command> and enter the password of the <systemitem class="username">root</systemitem> user.</listitem>
					<listitem><systemitem class="osname">Ubuntu</systemitem> -- To become the <systemitem class="username">root</systemitem> user, issue the command <command>sudo su -</command> and enter the password of the <systemitem class="username">root</systemitem> user.</listitem>
				</itemizedlist>
				<para>To switch from the <systemitem class="username">root</systemitem> user to a different user, issue the command <command>su - USERNAME</command>. For example, to switch from the <systemitem class="username">root</systemitem> user to the <systemitem class="username">opensrf</systemitem> user, issue the command <command>su - opensrf</command>. Once you have become a non-root user, to become the <systemitem class="username">root</systemitem> user again, simply issue the command <command>exit"</command>.</para>
			</note>
			<section>
				<title>Add the OpenSRF User</title>
				<para>As the <systemitem class="username">root</systemitem> user, add the opensrf user to the system. The default shell for the new user is automatically set to <command>/bin/bash</command> to inherit a reasonable environment:</para>
				<figure>
					<title>Commands to add <systemitem class="username">opensrf</systemitem> user</title>
					<screen>
					$ su - opensrf
					$ useradd -m -s /bin/bash opensrf
					$ passwd opensrf
					Enter new UNIX password: ******
					Retype new UNIX password: ******
					passwd: password updated successfully
					$
					</screen>
				</figure>
			</section>
			<section>
				<title>Download and Unpack Latest OpenSRF Version</title>
				<para>As the <systemitem class="username">opensrf</systemitem> user, download and extract the latest version of OpenSRF. The latest version can be found here: <ulink url="http://evergreen-ils.org/downloads/OpenSRF-1.2.2.tar.gz"></ulink></para>
				<figure>
					<title>Commands to download and unpack OpenSRF</title>
					<screen>
					$ su - opensrf
					$ wget http://evergreen-ils.org/downloads/OpenSRF-1.2.2.tar.gz
					$ tar zxf OpenSRF-1.2.2.tar.gz
					</screen>
				</figure>
				<para>The new directory <filename class="directory">/home/opensrf/OpenSRF-1.2.2</filename> will be created.</para>
			</section>
			<section>
				<title>Install Prerequisites to Build OpenSRF</title>
				<para>In this section you will install and configure a set of prerequisites that will be used to build OpenSRF. In a following step you will actually build the software using the <command>make</command> utility.</para>
				<para>As the <systemitem class="username">root</systemitem> user, enter the commands show below to build the prerequisites from the software distribution that you just downloaded and unpacked. Remember to replace <emphasis>[DISTRIBUTION]</emphasis> in the example with the keyword corresponding to the actual <systemitem class="osname">Linux</systemitem> distribution listed in the <link linkend="serversideinstallation-keywords-figure-1">"Keywords"</link> figure below.</para>
				<figure>
					<title>Commands to install prerequisites for OpenSRF</title>
					<screen>
					$ su - root
					$ cd /home/opensrf/OpenSRF-1.2.2
					$ make -f src/extras/Makefile.install [DISTRIBUTION]
					...
					</screen>
				</figure>
				<table xml:id="serversideinstallation-keywords-figure-1">
					<title>Keywords Targets for <application>make</application></title>
					<tgroup align="left" cols="2" colsep="1" rowsep="1">
						<colspec colnum="1" colwidth="1*"/>
						<colspec colnum="2" colwidth="3*"/>
						<thead>
							<row>
								<entry>Keyword</entry>
								<entry>Description</entry>
							</row>
						</thead>
						<tbody>
							<row>
								<entry>debian-lenny</entry>
								<entry>for Debian Lenny (5.0)</entry>
							</row>
							<row>
								<entry>debian-etch</entry>
								<entry>for Debian Etch (4.0)</entry>
							</row>
							<row>
								<entry>ubuntu-karmic</entry>
								<entry>for Ubuntu Karmic (9.10)</entry>
							</row>
							<row>
								<entry>ubuntu-intrepid</entry>
								<entry>for Ubuntu Jaunty (9.04) or Intrepid (8.10)</entry>
							</row>
							<row>
								<entry>ubuntu-hardy</entry>
								<entry>for Ubuntu Hardy (8.04)</entry>
							</row>
						</tbody>
					</tgroup>
				</table>
				<indexterm>
					<primary>ZZZ-REVIEW</primary>
					<secondary>ADD INFO FOR OTHER LINUX DISTRIBUTIONS </secondary>
				</indexterm>
				<caution>ADD INFO FOR OTHER LINUX DISTRIBUTIONS </caution>
				<para>This will install a number of packages on the system that are required by OpenSRF, including some Perl modules from CPAN. You can say <literal>No</literal> to the initial CPAN configuration prompt to allow it to automatically configure itself to download and install Perl modules from CPAN. The CPAN installer will ask you a number of times whether it should install prerequisite modules - say <literal>Yes</literal>.</para>
			</section>
			<section>
				<title>Configure OpenSRF</title>
				<para>As the <systemitem class="username">opensrf</systemitem> user, return to the OpenSRF build directory and use the <command>configure</command> utility to prepare for the next step of compiling and linking the software. You can include the  <option>--enable-python</option> and <option>--enable-java</option> configuration options if you wish to include support for Python and Java, respectively:</para>
				<figure>
					<title>Commands to configure OpenSRF</title>
					<screen>
					$ su - opensrf
					$ cd /home/opensrf/OpenSRF-1.2.2
					$ ./configure --prefix=/openils --sysconfdir=/openils/conf
					$ make
					...
					</screen>
				</figure>
			</section>
			<section>
				<title>Compile, Link and Install OpenSRF</title>
				<para>As the <systemitem class="username">root</systemitem> user, return to the OpenSRF build directory and use the <command>make</command> utility to compile, link and install OpenSRF:</para>
				<figure>
					<title>Commands to build, link and install OpenSRF</title>
					<screen>
					$ su - opensrf
					$ cd /home/opensrf/OpenSRF-1.2.2
					$ make install
					...
					</screen>
				</figure>
			</section>
			<section>
				<title>Update the System Dynamic Library Path</title>
				<para>As the <systemitem class="username">root</systemitem> user, you must update the system dynamic library path to make your system recognize the newly installed libraries. Do this by creating the new file <filename>/etc/ld.so.conf.d/osrf.conf</filename> containing a new library path, then run the command <command>ldconfig</command> to automatically read the file and modify the system dynamic library path:</para>
				<figure>
					<title>Commands to modify system dynamic library path</title>
					<screen>
					$ su - root
					$ echo "/openils/lib" > /etc/ld.so.conf.d/osrf.conf
					$ ldconfig
					</screen>
				</figure>
			</section>
			<section>
				<title>Define Public and Private OpenSRF Domains</title>
				<para>Define your public and private OpenSRF domains. For security purposes, OpenSRF uses Jabber domains to separate services into public and private realms. Throughout these instructions, we will use the example domains <systemitem class="domainname">public.localhost</systemitem> for the public domain and <systemitem class="domainname">private.localhost</systemitem> for the private domain. On a single-server system, the easiest way to define public and private domains is to define separate hostnames by adding entries to the file <filename>/etc/hosts</filename>.</para>
				<para>As the <systemitem class="username">root</systemitem> user, edit the file <filename>/etc/hosts</filename> and add the following entries for our example domains:</para>
				<figure>
					<title>Example public and private domains in /etc/hosts</title>
					<screen>
					127.0.1.2	public.localhost	public
					127.0.1.3	private.localhost	private
					</screen>
				</figure>
			</section>
			<section>
				<title>Change File Ownerships</title>
				<para>As the <systemitem class="username">root</systemitem> user, change the ownership of files installed in the directory <filename class="directory">/openils</filename> to the <systemitem class="username">opensrf</systemitem> user:</para>
				<figure>
					<title>Commands to change file ownerships</title>
					<screen>
					$ chown -R opensrf:opensrf /openils
					</screen>
				</figure>
			</section>
			<section>
				<title>Stop the <systemitem class="service">ejabberd</systemitem> Service</title>
				<para>As the <systemitem class="username">root</systemitem> user, stop the <systemitem class="service">ejabberd</systemitem> service:</para>
				<figure>
					<title>Commands to stop the <systemitem class="service">ejabberd</systemitem> service</title>
					<screen>
					$ /etc/init.d/ejabberd stop
					</screen>
				</figure>
				<para>If <systemitem class="service">ejabberd</systemitem> reports that it is already stopped, it may have run into a problem starting back at the installation stage. One possible fix is to kill any remaining <systemitem class="daemon">beam</systemitem> and <systemitem class="daemon">epmd</systemitem> processes, then edit the configuration file <filename>/etc/ejabberd/ejabberd.cfg</filename> to hardcode a domain:</para>
				<figure>
					<title>Commands to recover from <systemitem class="service">ejabberd</systemitem> errors</title>
					<screen>
					$ su - root
					$ epmd -kill
					$ killall beam; killall beam.smp
					$ rm /var/lib/ejabberd/*
					$ echo 'ERLANG_NODE=ejabberd@localhost' >> /etc/default/ejabberd
					</screen>
				</figure>
			</section>
			<section>
				<title>Edit the <systemitem class="service">ejabberd</systemitem> configuration</title>
				<para>As the <systemitem class="username">root</systemitem> user, edit the file <filename>/etc/ejabberd/ejabberd.cfg</filename> and make the following changes:</para>
				<itemizedlist>
					<listitem>Change <literal>{hosts, ["localhost"]}.</literal> to <literal>{hosts, ["localhost", "private.localhost", "public.localhost"]}.</literal></listitem>
					<listitem>Change <literal>{max_user_sessions, 10}.</literal> to <literal>{max_user_sessions, 10000}.</literal> If you see something like this instead: <literal>{access, max_user_sessions, [{10, all}]}.</literal>, then change it to <literal>{access, max_user_sessions, [{10000, all}]}.</literal></listitem>
					<listitem>Change all three occurrences of <literal>max_stanza_size</literal> to <literal>2000000</literal>.</listitem>
					<listitem>Change both occurrences of <literal>maxrate</literal> to <literal>500000</literal>.</listitem>
					<listitem>Comment out the line <literal>{mod_offline, []}</literal> by placing two <literal>%</literal> comment signs in front.</listitem>
				</itemizedlist>
			</section>
			<section>
				<title>Restart the <systemitem class="service">ejabberd</systemitem> service</title>
				<para>As the <systemitem class="username">root</systemitem> user, restart the <systemitem class="service">ejabberd</systemitem> service to test the configuration changes and to register your users:</para>
				<figure>
					<title>Commands to restart the <systemitem class="service">ejabberd</systemitem> service</title>
					<screen>
					$ /etc/init.d/ejabberd start
					</screen>
				</figure>
			</section>
			<section>
				<title>Register <systemitem class="username">router</systemitem> and <systemitem class="username">ejabberd</systemitem> users</title>
				<para>On each domain, you need two <systemitem class="service">ejabberd</systemitem> users to manage the OpenSRF communications:</para>
				<itemizedlist>
					<listitem>a <systemitem class="username">router</systemitem> user, to whom all requests to connect to an OpenSRF service will be routed; this <systemitem class="service">ejabberd</systemitem> user must be named <systemitem class="username">router</systemitem></listitem>
					<listitem>an <systemitem class="username">opensrf</systemitem> user, which clients use to connect to OpenSRF services; this user can be named anything you like, but we will use <literal>opensrf</literal> in our examples</listitem>
				</itemizedlist>
				<para>As the <systemitem class="username">root</systemitem> user, use the <command>ejabberdctl</command> utility to register your ejabber users <emphasis>router</emphasis> and <emphasis>opensrf</emphasis> for the OpenSRF router service on each domain. The users should have different passwords on each domain. These users will correspond to those configured in the file <filename>/openils/conf/opensrf_core.xml</filename>:</para>
				<figure>
					<title>Commands to register <systemitem class="username">router</systemitem> and <systemitem class="username">ejabberd</systemitem> users</title>
					<programlisting language="xml"><![CDATA[
					# Syntax for registering a user with ejabberdctl:
					#    ejabberdctl register <user> <domain> <password>
					#
					$ ejabberdctl register router private.localhost  <password>
					$ ejabberdctl register opensrf private.localhost <password>
					$ ejabberdctl register router public.localhost   <password>
					$ ejabberdctl register opensrf public.localhost  <password>
					]]></programlisting>
				</figure>
			</section>
			<section>
				<title>Create configuration files</title>
				<para>As the <systemitem class="username">opensrf</systemitem> user, use the example templates to create the configuration files <filename>/openils/conf/opensrf_core.xml</filename> and <filename>/openils/conf/opensrf.xml</filename>:</para>
				<figure>
					<title>Commands to create configuration files</title>
					<screen>
					$ su - root
					$ cd /openils/conf
					$ cp opensrf.xml.example      opensrf.xml
					$ cp opensrf_core.xml.example opensrf_core.xml
					</screen>
				</figure>
			</section>
			<section>
				<title>Edit opensrf_core.xml</title>
				<para>Edit the file <filename>/openils/conf/opensrf_core.xml</filename> to change the <systemitem class="service">ejabberd</systemitem> usernames and passwords as follows.</para>
				<note>
					<para>
						<emphasis>The following example uses common XPath syntax on the left-hand side to indicate the approximage position needing changes within the XML file.</emphasis>
					</para>
				</note>
				<figure>
					<title>Updates needed in the file <filename>/openils/conf/opensrf_core.xml</filename></title>
					<screen>
					/config/opensrf/username = opensrf

					/config/opensrf/passwd = password for "private.localhost" opensrf user

					/config/gateway/username = opensrf

					/config/gateway/passwd = password for "public.localhost" opensrf user

					# first entry, where "transport/server" == "public.localhost" :
					/config/routers/router/transport 
					    username = router
					    password = password for "public.localhost" router user

					# second entry, where "transport/server" == "private.localhost" :
					/config/routers/router/transport
					    username = router
					    password = password for "private.localhost" router user
					</screen>
				</figure>
				<para>You also need to specify the domains from which OpenSRF will accept and to which OpenSRF will make connections. If you are installing OpenSRF on a single server and using the <systemitem class="domainname">private.localhost</systemitem> / <systemitem class="domainname">public.localhost</systemitem> domains, these will already be set to the correct values. Otherwise, search and replace to match your values.</para>
			</section>
			<section>
				<title>Modify the file <filename>opensrf.xml</filename></title>
				<para>As the <systemitem class="username">opensrf</systemitem> user, edit the file <filename>/openils/conf/opensrf.xml</filename> to set the location of the persistent database in the <literal>dbfile</literal> element near the end of the file:</para>
				<figure>
					<title>Example of the file <filename>opensrf.xml</filename></title>
					<programlisting language="xml"><![CDATA[
					<!-- Example of an app-specific setting override -->
					<opensrf.persist>
					  <app_settings>
					    <dbfile>/tmp/persist.db</dbfile>
					  </app_settings>
					</opensrf.persist>
					]]></programlisting>
				</figure>
			</section>
			<section>
				<title>Create Configuration Files for Users Needing <application>srfsh</application></title>
				<para>In this section you will set up a special configuration file for each user who will need to run the <application>srfsh</application> (pronounced <emphasis>surf shell</emphasis>) utility.</para>
				<para>The software installation will automatically create <application>srfsh</application>. This is a command line diagnostic tool for testing and interacting with the OpenSRF network software. It will be used in a future step to complete and test the Evergreen installation. See <xref linkend="serversideinstallation-testing"/> for further information.</para>
				<para>As the <systemitem class="username">root</systemitem> user, copy the short sample configuration file <filename>/openils/conf/srfsh.xml.example</filename> to the file <filename>.srfsh.xml</filename> (note the leading dot!) in the home directory of each user who will use <application>srfsh</application>. Finally, edit each file <filename>.srfsh.xml</filename> and make the following changes. When you finish, remember to change the owner of the file to match the owner of the home directory.</para>
				<itemizedlist>
					<listitem>Modify <literal>domain</literal> to be the router hostname (following our domain examples, <systemitem class="domainname">private.localhost</systemitem> will give <application>srfsh</application> access to all OpenSRF services, while <systemitem class="domainname">public.localhost</systemitem> will only allow access to those OpenSRF services that are publicly exposed).</listitem>
					<listitem>Modify <literal>username</literal> and <literal>password</literal> to match the <literal>opensrf</literal> Jabber user for the chosen domain</listitem>
					<listitem>Modify <literal>logfile</literal> to be the full path for a log file to which the user has write access</listitem>
					<listitem>Modify <literal>loglevel</literal> as needed for testing</listitem>
				</itemizedlist>
				<figure>
					<title>Example of the file <filename>/openils/conf/srfsh.xml.example</filename></title>
					<programlisting language="xml"><![CDATA[
					<?xml version="1.0"?>
					<!-- This file follows the standard bootstrap config file layout -->
					<!-- found in opensrf_core.xml -->
					<srfsh>
					<router_name>router</router_name>
					<domain>private.localhost</domain>
					<username>opensrf</username>
					<passwd>privsrf</passwd>
					<port>5222</port>
					<logfile>/tmp/srfsh.log</logfile>
					<!-- 0 None, 1 Error, 2 Warning, 3 Info, 4 debug, 5 Internal (Nasty) -->
					<loglevel>4</loglevel>
					</srfsh>
					]]></programlisting>
				</figure>
			</section>
			<section>
				<title>Modify Environmental Variable PATH for <systemitem class="username">opensrf</systemitem> User</title>
				<para>As the <systemitem class="username">opensrf</systemitem> user, modify the environmental variable <envar>PATH</envar> by adding a new file path to the <systemitem class="username">opensrf</systemitem> user's shell configuration file <filename>.bashrc</filename>:</para>
				<figure>
					<title>Commands to add path to <filename>.bashrc</filename> configuration file</title>
					<screen>
					$ su - opensrf
					$ echo "export PATH=/openils/bin:\$PATH" >> ~/.bashrc
					</screen>
				</figure>
			</section>
			<section>
				<title>Starting OpenSRF</title>
				<para>As the <systemitem class="username">root</systemitem> user, start the <systemitem class="service">ejabberd</systemitem> and <systemitem class="service">memcached</systemitem> services:</para>
				<figure>
					<title>Commands to start <systemitem class="service">ejabberd</systemitem> and <systemitem class="service">memcached</systemitem> services</title>
					<screen>
					$ su - root
					$ /etc/init.d/ejabberd start
					$ /etc/init.d/memcached start
					</screen>
				</figure>
				<para/>
				<para>Finally, as the <systemitem class="username">opensrf</systemitem> user, start OpenSRF:</para>
				<figure>
					<title>Commands to start OpenSRF</title>
					<screen>
					$ su - opensrf

					# ensure you have the needed path
					$ export PATH=$PATH:/openils/bin

					# start the OpenSRF service:
					# use "-l" to force hostname to be "localhost"
					$ osrf_ctl.sh -l -a start_all     
					</screen>
				</figure>
				<note>
					<para>
						<emphasis>You can also start Evergreen <emphasis role="bold">without</emphasis> the <emphasis>-l</emphasis> flag, but <emphasis>osrf_ctl.sh</emphasis> must know the fully qualified domain name for the system on which it will execute. That hostname may have been specified in the configuration file <filename>opensrf.xml</filename>, which you configured in a previous step.</emphasis>
					</para>
				</note>
			</section>
			<section>
				<title>Testing connections to OpenSRF</title>
				<para>Once you have installed and started OpenSRF, as the <systemitem class="username">root</systemitem> user, test your connection to OpenSRF using the <application>srfsh</application> utility and trying to call the <emphasis>add</emphasis> method on the OpenSRF <systemitem class="service">math</systemitem> service:</para>
				<figure>
					<title>Commands to test OpenSRF with <application>srfsh</application></title>
					<screen>
					$ su - opensrf
					$ /openils/bin/srfsh
					srfsh#  request opensrf.math add 2 2
					Received Data: 4
					------------------------------------
					Request Completed Successfully
					Request Time in seconds: 0.007519
					------------------------------------
					srfsh#
					</screen>
				</figure>
				<indexterm>
					<primary>ZZZ-REVIEW</primary>
					<secondary>VERIFY THIS TEST </secondary>
				</indexterm>
				<caution>VERIFY THIS TEST </caution>
				<para>For other <application>srfsh</application> commands, type <userinput>help</userinput> in at the prompt.</para>
			</section>
			<section>
				<title>Stopping OpenSRF</title>
				<para>As the <systemitem class="username">opensrf</systemitem> user, stop OpenSRF:</para>
				<figure>
					<title>Commands to stop OpenSRF</title>
					<screen>
					$ su - opensrf
					$ osrf_ctl.sh -l -a stop_all
					</screen>
				</figure>
			</section>
		</section>
		<section xml:id="serversideinstallation-ubuntudebian">
			<title>Installing Evergreen 1.6.x.x On <systemitem class="osname">Ubuntu</systemitem> or <systemitem class="osname">Debian</systemitem></title>
			<para>This section outlines the installation process for the latest stable version of Evergreen.</para>
			<para>In this section you will download, unpack, install, configure and test the Evergreen system, including the Evergreen server and the PostgreSQL database system. You will make several configuration changes and adjustments to the software, including updates to configure the system for your own locale, and some updates needed to work around a few known issues.</para>
			<note>
				<para>The following steps have been tested on the x86 (32-bit) and x86-64 (64-bit) architectures. There may be differences between the Desktop and Server editions of <systemitem class="osname">Ubuntu</systemitem>. These instructions assume the Server edition.</para>
				<para>In the following instructions, you are asked to perform certain steps as either the <systemitem class="username">root</systemitem> user, the <systemitem class="username">opensrf</systemitem> user, or the <systemitem class="username">postgres</systemitem> user.</para>
				<itemizedlist>
					<listitem><systemitem class="osname">Debian</systemitem> -- To become the <systemitem class="username">root</systemitem> user, issue the command <command>su -</command> and enter the password of the <systemitem class="username">root</systemitem> user.</listitem>
					<listitem><systemitem class="osname">Ubuntu</systemitem> -- To become the <systemitem class="username">root</systemitem> user, issue the command <command>sudo su -</command> and enter the password of the <systemitem class="username">root</systemitem> user.</listitem>
				</itemizedlist>
				<para>To switch from the <systemitem class="username">root</systemitem> user to a different user, issue the command <command>su - USERNAME</command>. For example, to switch from the <systemitem class="username">root</systemitem> user to the <systemitem class="username">opensrf</systemitem> user, issue the command <command>su - opensrf</command>. Once you have become a non-root user, to become the <systemitem class="username">root</systemitem> user again, simply issue the command <command>exit</command>.</para>
			</note>
			<section>
				<title>Installing OpenSRF</title>
				<para>Evergreen software is integrated with and depends on the Open Service Request Framework (OpenSRF) software system. For further information on installing, configuring and testing OpenSRF, see <xref linkend="serversideinstallation-opensrf"/>.</para>
				<para>Follow the steps outlined in that section and run the specified tests to ensure that OpenSRF is properly installed and configured. Do not continue with any further Evergreen installation steps until you have verified that OpenSRF has been successfully installed.</para>
			</section>
			<section>
				<title>Download and Unpack Latest Evergreen Version</title>
				<para>As the <systemitem class="username">opensrf</systemitem> user, download and extract the latest version of Evergreen. The latest version can be found here: <ulink url="http://evergreen-ils.org/downloads/Evergreen-ILS-1.6.0.7.tar.gz"></ulink></para>
				<figure>
					<title>Commands to download and unpack Evergreen</title>
					<screen>
					$ su - opensrf
					$ wget http://evergreen-ils.org/downloads/Evergreen-ILS-1.6.0.7.tar.gz
					$ tar zxf Evergreen-ILS-1.6.0.7.tar.gz
					</screen>
				</figure>
				<para>The new directory <filename class="directory">/home/opensrf/Evergreen-ILS-1.6.0.7</filename> will be created.</para>
			</section>
			<section>
				<title>Install Prerequisites to Build Evergreen</title>
				<para>In this section you will install and configure a set of prerequisites that will be used to build Evergreen. In a following step you will actually build the software using the <command>make</command> utility.</para>
				<para>As the <systemitem class="username">root</systemitem> user, enter the commands show below to build the prerequisites from the software distribution that you just downloaded and unpacked. Remember to replace <emphasis>[distribution]</emphasis> in the example with the keyword corresponding to the actual <systemitem class="osname">Linux</systemitem> distribution listed in the <link linkend="serversideinstallation-keywords-figure-2">"Keywords"</link> figure below.</para>
				<figure>
					<title>Commands to install prerequisites for Evergreen</title>
					<screen>
					$ su - root
					$ cd /home/opensrf/Evergreen-ILS-1.6.0.7
					$ make -f Open-ILS/src/extras/Makefile.install [distribution]
					...
					</screen>
				</figure>
				<table xml:id="serversideinstallation-keywords-figure-2">
					<title>Keywords Targets for <application>make</application></title>
					<tgroup align="left" cols="2" colsep="1" rowsep="1">
						<colspec colnum="1" colwidth="1*"/>
						<colspec colnum="2" colwidth="3*"/>
						<thead>
							<row>
								<entry>Keyword</entry>
								<entry>Description</entry>
							</row>
						</thead>
						<tbody>
							<row>
								<entry>debian-lenny</entry>
								<entry>for Debian Lenny (5.0), the most recent version</entry>
							</row>
							<row>
								<entry>debian-etch</entry>
								<entry>for Debian Etch (4.0)</entry>
							</row>
							<row>
								<entry>ubuntu-karmic</entry>
								<entry>for Ubuntu Lucid (10.04) [same as for Karmic]</entry>
							</row>
							<row>
								<entry>ubuntu-karmic</entry>
								<entry>for Ubuntu Karmic (9.10)</entry>
							</row>
							<row>
								<entry>ubuntu-intrepid</entry>
								<entry>for Ubuntu Intrepid (8.10)</entry>
							</row>
							<row>
								<entry>ubuntu-hardy</entry>
								<entry>for Ubuntu Hardy (8.04)</entry>
							</row>
							<row>
								<entry>ubuntu-gutsy</entry>
								<entry>for Ubuntu Gutsy (7.10)</entry>
							</row>
							<row>
								<entry>gentoo</entry>
								<entry>generic for Gentoo versions</entry>
							</row>
							<row>
								<entry>centos</entry>
								<entry>generic for Centos versions</entry>
							</row>
						</tbody>
					</tgroup>
				</table>
				<indexterm>
					<primary>ZZZ-REVIEW</primary>
					<secondary>ADD INFO FOR OTHER LINUX DISTRIBUTIONS </secondary>
				</indexterm>
				<caution>ADD INFO FOR OTHER LINUX DISTRIBUTIONS </caution>
			</section>
			<section>
				<title>(OPTIONAL) Install the PostgreSQL Server</title>
				<para>Since the PostgreSQL server is usually a standalone server in multi-server production systems, the prerequisite installer Makefile in the previous step does not automatically install PostgreSQL. If your PostgreSQL server is on a different system, just skip this step.</para>
				<para>For further information on installing PostgreSQL, see <xref linkend="serversideinstallation-postgresql"/>.</para>
				<para>If your PostgreSQL server will be on the same system as your Evergreen software, then as the <systemitem class="username">root</systemitem> user install the required PostgreSQL server packages:</para>
				<figure>
					<title>Commands to install the PostgreSQL server</title>
					<screen>
					$ su - root
	
					# Debian Lenny and Ubuntu Hardy (8.04)
					$ make -f Open-ILS/src/extras/Makefile.install install_pgsql_server_debs_83
					...

					# Ubuntu Karmic (9.10) and Ubuntu Lucid (10.04)
					$ make -f Open-ILS/src/extras/Makefile.install install_pgsql_server_debs_84
					...
					</screen>
				</figure>
				<note>
					<para>
						<emphasis>PostgreSQL 8.1 is deprecated and will become unsupported in a future release, though existing installations upgrading from Evergreen 1.4 or before will work fine. However, consider upgrading your Postgres soon!</emphasis>
					</para>
				</note>
				<indexterm>
					<primary>ZZZ-REVIEW</primary>
					<secondary>VERIFY: IS THIS STILL TRUE? </secondary>
				</indexterm>
				<caution>VERIFY: IS THIS STILL TRUE? </caution>
				<indexterm>
					<primary>ZZZ-REVIEW</primary>
					<secondary>ADD INFO ON HOW TO DETERMINE WHICH VERSION OF POSTGRESQL YOU HAVE </secondary>
				</indexterm>
				<caution>ADD INFO ON HOW TO DETERMINE WHICH VERSION OF POSTGRESQL YOU HAVE </caution>
			</section>
			<section>
				<title>(OPTIONAL) Install Perl Modules on PostgreSQL Server</title>
				<para>If PostgreSQL is running on the same system as your Evergreen software, then the Perl modules will automatically be available. Just skip this step.</para>
				<para>Otherwise, if your PostgreSQL server is running on another system, then as the <systemitem class="username">root</systemitem> user install the following Perl modules on that system:</para>
				<figure>
					<title>Commands to install Perl modules</title>
					<screen>
					# ensure the gcc compiler is installed
					$ su - root
					$ aptitude install gcc
	
					# install the Perl modules
					$ perl -MCPAN -e shell
					cpan> install JSON::XS
					cpan> install MARC::Record
					cpan> install MARC::File::XML
					</screen>
				</figure>
				<indexterm>
					<primary>ZZZ-REVIEW</primary>
					<secondary>ADD INFO ON HOW TO INSTALL THE PERL MODULES </secondary>
				</indexterm>
				<caution>ADD INFO ON HOW TO INSTALL THE PERL MODULES </caution>
				<indexterm>
					<primary>ZZZ-REVIEW</primary>
					<secondary>ADD INFO ON HOW TO VERIFY THAT THE PERL MODULES ARE INSTALLED </secondary>
				</indexterm>
				<caution>ADD INFO ON HOW TO VERIFY THAT THE PERL MODULES ARE INSTALLED </caution>
			</section>
			<section>
				<title>Update the System Dynamic Library Path</title>
				<para>As the <systemitem class="username">root</systemitem> user, you must update the system dynamic library path to make your system recognize the newly installed libraries. Do this by creating the new file <filename>/etc/ld.so.conf.d/eg.conf</filename> containing two new library paths, then run the command <command>ldconfig</command> to automatically read the file and modify the system dynamic library path:</para>
				<figure>
					<title>Commands to modify system dynamic library path</title>
					<screen>
					$ su - root
					$ cat > /etc/ld.so.conf.d/eg.conf &lt;&lt; ENDOFFILE
					/usr/local/lib
					/usr/local/lib/dbd
					ENDOFFILE
					$ ldconfig
					</screen>
				</figure>
			</section>
			<section>
				<title>(OPTIONAL) Restart the PostgreSQL Server</title>
				<para>If PostgreSQL is running on the same system as the rest of Evergreen, as the <systemitem class="username">root</systemitem> user you must restart the PostgreSQL server to avoid a problem where the library <filename>plperl.so</filename> cannot be found. If your PostgreSQL server is running on another system, just skip this step.</para>
				<indexterm>
					<primary>ZZZ-REVIEW</primary>
					<secondary>ADD INFO ON OTHER VERSIONS OF POSTGRESQL </secondary>
				</indexterm>
				<caution>ADD INFO ON OTHER VERSIONS OF POSTGRESQL </caution>
				<figure>
					<title>Commands to restart PostgreSQL server</title>
					<screen>
					$ su - root
					$ /etc/init.d/postgresql-PGSQL_VERSION restart
					</screen>
				</figure>
				<emphasis>Where <literal>PGSQL_VERSION</literal> is your installed PostgreSQL version (e.g. <literal>8.3</literal>).</emphasis>
			</section>
			<section xml:id="serversideinstallation-configure">
				<title>Configure Evergreen</title>
				<para>As the <systemitem class="username">opensrf</systemitem> user, return to the Evergreen build directory and use the <command>configure</command> utility to prepare for the next step of compiling and linking the software:</para>
				<figure>
					<title>Commands to configure Evergreen</title>
					<screen>
					$ su - opensrf
					$ cd /home/opensrf/Evergreen-ILS-1.6.0.7
					$ ./configure --prefix=/openils --sysconfdir=/openils/conf
					$ make
					...
					</screen>
				</figure>
			</section>
			<section xml:id="serversideinstallation-compilingevergreen">
				<title>Compile, Link and Install Evergreen</title>
				<para>In this step you will actually compile, link and install Evergreen and the default Evergreen Staff Client.</para>
				<para>As the <systemitem class="username">root</systemitem> user, return to the Evergreen build directory and use the <command>make</command> utility as shown below. The Staff Client will also be automatically built, but you must remember to set the variable <envar>STAFF_CLIENT_BUILD_ID</envar> to match the version of the Staff Client you will use to connect to the Evergreen server.</para>
				<para>For further information on manually building the Staff Client, see <xref linkend="serversideinstallation-building-staffclient"/>.</para>
				<figure>
					<title>Commands to build, link and install Evergreen</title>
					<screen>
					$ su - root
					$ cd /home/opensrf/Evergreen-ILS-1.6.0.7
					$ make STAFF_CLIENT_BUILD_ID=rel_1_6_0_7 install
					...
					</screen>
					<para>The above commands will create a new subdirectory <filename class="directory">/openils/var/web/xul/rel_1_6_0_7</filename> containing the Staff Client.</para>
				</figure>
				<para>To complete the Staff Client installation, as the <systemitem class="username">root</systemitem> user create a symbolic link named <emphasis>server</emphasis> in the head of the Staff Client directory <filename class="directory">/openils/var/web/xul</filename> that points to the subdirectory <filename class="directory">/server</filename> of the new Staff Client build:</para>
				<figure>
					<title>Commands to create symbolic link</title>
					<screen>
					$ su - root
					$ cd /openils/var/web/xul
					$ ln -sf rel_1_6_0_7/server server
					</screen>
				</figure>
			</section>
			<section>
				<title>Copy the OpenSRF Configuration Files</title>
				<para>As the <systemitem class="username">root</systemitem> user, copy the example OpenSRF configuration files into place. This replaces the configuration files that you set up in a previous step when you installed and tested OpenSRF. You should also create backup copies of the old files for troubleshooting purposes. Finally, change the ownership on the installed files to the <systemitem class="username">opensrf</systemitem> user:</para>
				<figure>
					<title>Commands to copy OpenSRF configuration files</title>
					<screen>
					$ su - root
					$ cp /openils/conf/opensrf.xml.example      /openils/conf/opensrf.xml
					$ cp /openils/conf/opensrf_core.xml.example /openils/conf/opensrf_core.xml
					$ cp /openils/conf/oils_web.xml.example     /openils/conf/oils_web.xml
					$ chown -R opensrf:opensrf /openils/
					</screen>
				</figure>
			</section>
			<section>
				<title>Create and Configure PostgreSQL Database</title>
				<para>As the <systemitem class="username">postgres</systemitem> user on your PostgreSQL server, create the Evergreen database.</para>
				<para>In the commands below, remember to adjust the path of the <emphasis role="bold">contrib</emphasis> repository to match your PostgreSQL server layout. For example, if you built PostgreSQL from source the path would be <filename class="directory">/usr/local/share/contrib</filename>; if you installed the PostgreSQL 8.3 server packages on <systemitem class="osname">Ubuntu 8.04</systemitem>, the path would be <filename class="directory">/usr/share/postgresql/8.3/contrib/</filename>.</para>
				<procedure>
					<step>
						<para>
							<emphasis role="bold">Create and configure the database</emphasis>
						</para>
						<para>As the <systemitem class="username">postgres</systemitem> user on the PostgreSQL system create the PostgreSQL database, then set some internal paths:</para>
						<figure>
							<title>Commands to create database and adjust the path</title>
							<screen>
							# create the database
							$ su - postgres
							$ createdb -E UNICODE evergreen
							$ createlang plperl   evergreen
							$ createlang plperlu  evergreen
							$ createlang plpgsql  evergreen
		
							# adjust the paths
							$ psql -f /usr/share/postgresql/PGSQL_VERSION/contrib/tablefunc.sql evergreen
							$ psql -f /usr/share/postgresql/PGSQL_VERSION/contrib/tsearch2.sql  evergreen
							$ psql -f /usr/share/postgresql/PGSQL_VERSION/contrib/pgxml.sql     evergreen
							</screen>
						</figure>
						<emphasis>Where <literal>PGSQL_VERSION</literal> is your installed PostgreSQL version (e.g. <literal>8.3</literal>).</emphasis>
					</step>
					<step>
						<para>
							<emphasis role="bold">Create new Evergreen superuser</emphasis>
						</para>
						<para>As the <systemitem class="username">postgres</systemitem> user on the PostgreSQL system, create the new database <systemitem class="username">evergreen</systemitem> user and assign a password:</para>
						<figure>
							<title>Commands to create the <systemitem class="username">evergreen</systemitem> user</title>
							<screen>
							# create superuser 'evergreen' and set the password
							$ su - postgres
							$ createuser -P -s evergreen
							Enter password for new role: MYNEWPASSWORD
							Enter it again: MYNEWPASSWORD
							</screen>
						</figure>
						<emphasis>Where <literal>MYNEWPASSWORD</literal> is the password chosen.</emphasis>
					</step>
				</procedure>
			</section>
			<section>
				<title>Create Database Schema</title>
				<para>As the <systemitem class="username">root</systemitem> user, create the database schema and configure your system with the corresponding database authentication details for the <emphasis>evergreen</emphasis> database user that you created in the previous step.</para>
				<para>Enter the following commands and replace <emphasis>HOSTNAME, PORT, PASSWORD</emphasis> and <emphasis>DATABASENAME</emphasis> with appropriate values.</para>
				<figure>
					<title>Commands to create Evergreen database schema</title>
					<screen>
					$ su - root
					$ cd /home/opensrf/Evergreen-ILS-1.6.0.7
					$ perl Open-ILS/src/support-scripts/eg_db_config.pl --update-config \
						--service all --create-schema --create-bootstrap --create-offline \
						--hostname HOSTNAME --port PORT \
						--user evergreen --password PASSWORD --database DATABASENAME
					</screen>
				</figure>
				<emphasis>Where, on most systems, <emphasis>HOSTNAME</emphasis> will be <emphasis role="bold">localhost</emphasis>, <emphasis>PORT</emphasis> will be <emphasis role="bold">5432</emphasis>, and <emphasis>PASSWORD</emphasis> and <emphasis>DATABASENAME</emphasis> will be those assigned when PostgreSQL was installed in the previous step.</emphasis>
				<note>
					<para>
						<emphasis>If you are entering the above command on a single line, do not include the <literal>\</literal> (backslash) characters. If you are using the <command>bash</command> shell, these should only be used at the end of a line at a bash prompt to indicate that the command is continued on the next line.</emphasis>
					</para>
				</note>
			</section>
			<section xml:id="serversideinstallation-modify-apache">
				<title>Modify the Apache Configuration</title>
				<para>The Apache configuration must be updated in several ways to support Evergreen.</para>
				<section>
					<title>Configure the Apache Server</title>
					<para>Enable some built-in Apache modules with the utility <command>a2enmod</command>, and install some additional Apache configuration files. As the <systemitem class="username">root</systemitem> user, enable some modules in the Apache server, then copy the new configuration files to the Apache server directories:</para>
					<figure>
						<title>Commands to configure the Apache server</title>
						<screen>
						# configure the Apache server
						$ su - root
						$ a2enmod ssl	     # enable mod_ssl
						$ a2enmod rewrite    # enable mod_rewrite
						$ a2enmod expires    # enable mod_expires
						$ cd /home/opensrf/Evergreen-ILS-1.6.0.7
		
						# copy files
						$ cp Open-ILS/examples/apache/eg.conf	 /etc/apache2/sites-available/
						$ cp Open-ILS/examples/apache/eg_vhost.conf   /etc/apache2/
						$ cp Open-ILS/examples/apache/startup.pl      /etc/apache2/
						</screen>
					</figure>
				</section>
				<section xml:id="serversideinstallation-createsslkey">
					<title>Create a Security Certificate (SSL Key)</title>
					<para>Create a new SSL key for the Apache server with the command <command>openssl</command>. For a public production server you should configure or purchase a signed SSL certificate, but for now you can just use a self-signed certificate and accept the warnings in the Staff Client and browser during testing and development:</para>
					<figure>
						<title>Commands to create an SSL key</title>
						<screen>
						$ mkdir /etc/apache2/ssl
						$ cd /etc/apache2/ssl
						$ openssl req -new -x509 -days 365 -nodes -out server.crt -keyout server.key
						</screen>
					</figure>
					<warning>
						<para>
							<emphasis>This is only a temporary measure to expedite testing. You <emphasis role="bold">must</emphasis> get a proper SSL certificate for a public production system.</emphasis>
						</para>
						<para>For further information on getting a proper SSL certificate, see <xref linkend="serversideinstallation-ssl"/>.</para>
					</warning>
				</section>
				<section>
					<title>Modify the Apache Configuration File</title>
					<para>Several changes are needed in the new Apache configuration file <filename>/etc/apache2/sites-available/eg.conf</filename>. As the <systemitem class="username">root</systemitem> user, edit the file and make the following changes:</para>
					<procedure>
						<step>
							<para>Comment out the line <literal>Allow from 10.0.0.0/8</literal>, then uncomment the line <literal>Allow from all</literal>.</para>
							<para>
								<emphasis>This change allows access to your configuration CGI scripts from <emphasis role="bold">any</emphasis> workstation on <emphasis role="bold">any</emphasis> network. This is only a temporary change to expedite testing and should be removed after you have finished and successfully tested the Evergreen installation.</emphasis>
							</para>
							<warning>
								<para>
									<emphasis>You must remove these changes after testing is completed. See <xref linkend="serversideinstallation-postinstallation"/> for further details on removing this change after the Evergreen installation is complete.</emphasis>
								</para>
							</warning>
						</step>
						<step>
							<para>Comment out the line <literal>Listen 443</literal>, since it conflicts with the same declaration in the configuration file: <filename>/etc/apache2/ports.conf</filename>. <systemitem class="osname">Debian Etch</systemitem> users should not do this.</para>
							<indexterm>
								<primary>ZZZ-REVIEW</primary>
								<secondary>ADD INFO ON WHY DEBIAN ETCH USERS SHOULD NOT DO THIS </secondary>
							</indexterm>
							<caution>ADD INFO ON WHY DEBIAN ETCH USERS SHOULD NOT DO THIS </caution>
						</step>
						<step>
							<warning>
								<para>The following updates are needed to allow the logs to function properly, but it may break other Apache applications on your server.</para>
							</warning>
							<itemizedlist>
								<listitem>
									<para>For the <systemitem class="osname">Linux</systemitem> distributions <systemitem class="osname">Ubuntu Hardy</systemitem> or <systemitem class="osname">Debian Etch</systemitem>, as the <systemitem class="username">root</systemitem> user, edit the Apache configuration file <filename>/etc/apache2/apache2.conf</filename> and change the phrase: <literal>User www-data</literal> to the phrase: <literal>User opensrf</literal>.</para>
								</listitem>
								<listitem>
									<para>For the <systemitem class="osname">Linux</systemitem> distributions <systemitem class="osname">Ubuntu Karmic</systemitem> or <systemitem class="osname">Ubuntu Lucid</systemitem> or <systemitem class="osname">Debian Lenny</systemitem>, as the <systemitem class="username">root</systemitem> user, edit the Apache configuration file <filename>/etc/apache2/envvars</filename> and change the phrase: <literal>export APACHE_RUN_USER=www-data</literal> to the phrase: <literal>export APACHE_RUN_USER=opensrf</literal>.</para>
								</listitem>
							</itemizedlist>
						</step>
						<step>
							<para>As the <systemitem class="username">root</systemitem> user, edit the Apache configuration file <filename>/etc/apache2/apache2.conf</filename> and add the lines <literal>KeepAliveTimeout 1</literal> and <literal>MaxKeepAliveRequests 100</literal>, or modify any existing lines.</para>
						</step>
					</procedure>
				</section>
				<section>
					<title>(OPTIONAL) Performance Modifications for Apache</title>
					<para>Some further configuration changes to Apache may be necessary for busy systems. These changes increase the number of Apache server processes that are started to support additional browser connections.</para>
					<procedure>
						<step>As the <systemitem class="username">root</systemitem> user, edit the Apache configuration file <filename>/etc/apache2/apache2.conf</filename>, locate and modify the section related to <emphasis>prefork configuration</emphasis> to suit the load on your system.</step>
						<figure>
							<title>(OPTIONAL) Example of updates to Apache configuration</title>
							<programlisting language="xml"><![CDATA[
							<IfModule mpm_prefork_module>
							   StartServers		  20
							   MinSpareServers	   5
							   MaxSpareServers	  15
							   MaxClients		 150
							   MaxRequestsPerChild 10000
							</IfModule>
							]]></programlisting>
						</figure>
					</procedure>
				</section>
				<section>
					<title>Enable the Evergreen Web Site</title>
					<para>Finally, as the <systemitem class="username">root</systemitem> user, execute the following Apache configuration commands to disable the default <emphasis>It Works</emphasis> web page and to enable the Evergreen web site:</para>
					<figure>
						<title>Commands to enable the Evergreen Web Site</title>
						<screen>
						$ su - root
	
						# disable the default site
						$ a2dissite default
		
						# enable the Evergreen web site
						$ a2ensite eg.conf
						</screen>
					</figure>
				</section>
			</section>
			<section xml:id="serversideinstallation-opensrf-config">
				<title>Modify the OpenSRF Configuration File</title>
				<para>As the <systemitem class="username">opensrf</systemitem> user, edit the OpenSRF configuration file <filename>/openils/conf/opensrf_core.xml</filename> to update the Jabber usernames and passwords, and to specify the domain from which we will accept and to which we will make connections.</para>
				<para>If you are installing Evergreen on a single server and using the <systemitem class="domainname">private.localhost</systemitem> / <systemitem class="domainname">public.localhost</systemitem> domains, these will already be set to the correct values. Otherwise, search and replace to match your customized values.</para>
				<note>
					<para>
						<emphasis>The following example uses common XPath syntax on the left-hand side to indicate the approximate position needing changes within the XML file:</emphasis>
					</para>
				</note>
				<indexterm>
					<primary>ZZZ-REVIEW</primary>
					<secondary>ADD A BETTER DIAGRAM HERE </secondary>
				</indexterm>
				<caution>ADD A BETTER DIAGRAM HERE </caution>
				<figure>
					<title>Updates needed in the file <filename>/openils/conf/opensrf_core.xml</filename></title>
					<screen>
					/config/opensrf/username = opensrf
	
					/config/opensrf/passwd = password for "private.localhost" opensrf user
	
					/config/gateway/username = opensrf
	
					/config/gateway/passwd = password for "public.localhost" opensrf user
	
					# first entry, where "transport/server" == "public.localhost" :
					/config/routers/router/transport 
					    username = router
					    password = password for "public.localhost" router user

					# second entry, where "transport/server" == "private.localhost" :
					/config/routers/router/transport
					    username = router
					    password = password for "private.localhost" router user
					</screen>
				</figure>
			</section>
			<section xml:id="serversideinstallation-srfsh">
				<title>Create Configuration Files for Users Needing <application>srfsh</application></title>
				<para>The software installation will automatically create a utility named <application>srfsh</application> (surf shell). This is a command line diagnostic tool for testing and interacting with the OpenSRF network software. It will be used in a future step to complete and test the Evergreen installation. See <xref linkend="serversideinstallation-testing"/> for further information.</para>
				<para>In this section you will set up a special configuration file for each user who will need to run the utility. Copy the short sample configuration file <filename>/openils/conf/srfsh.xml.example</filename> to the file <filename>.srfsh.xml</filename> (note the leading dot!) in the home directory of each user who will use <application>srfsh</application>. Finally, edit each users' <filename>.srfsh.xml</filename> file and make the following changes:</para>
				<procedure>
					<step>Modify <emphasis role="bold">domain</emphasis> to be the router hostname (following our domain examples, <systemitem class="domainname">private.localhost</systemitem>> will give <application>srfsh</application> access to all OpenSRF services, while <systemitem class="domainname">public.localhost</systemitem> will only allow access to those OpenSRF services that are publicly exposed).</step>
					<step>Modify <emphasis role="bold">username</emphasis> and <emphasis role="bold">password</emphasis> to match the <systemitem class="username">opensrf</systemitem> Jabber user for the chosen domain</step>
					<step>Modify <emphasis role="bold">logfile</emphasis> to be the full path for a log file to which the user has write access</step>
					<step>Modify <emphasis role="bold">loglevel</emphasis> as needed for testing</step>
				</procedure>
				<figure>
					<title>Example of user's file <filename>.srfsh.xml</filename></title>
					<programlisting language="xml"><![CDATA[
					<?xml version="1.0"?>
					<!-- This file follows the standard bootstrap config file layout -->
					<!-- found in opensrf_core.xml -->
					<srfsh>
					<router_name>router</router_name>
					<domain>private.localhost</domain>
					<username>opensrf</username>
					<passwd>evergreen</passwd>
					<port>5222</port>
					<logfile>/tmp/srfsh.log</logfile>
					<!-- 0 None, 1 Error, 2 Warning, 3 Info, 4 debug, 5 Internal (Nasty) -->
					<loglevel>4</loglevel>
					</srfsh>
					]]></programlisting>
				</figure>
			</section>
			<section xml:id="serversideinstallation-opensrf-env">
				<title>Modify the OpenSRF Environment</title>
				<para>As the <systemitem class="username">opensrf</systemitem> user, change the permissions of <emphasis>.cgi</emphasis> files in the directory <filename class="directory">/openils/var/cgi-bin</filename> to <emphasis>executable</emphasis>, then modify the shell configuration file <filename>~/.bashrc</filename> for <systemitem class="username">opensrf</systemitem> by adding a Perl environmental variable. Finally, execute the shell configuration file to load the new variables into your current environment.</para>
				<note>
					<para>
						<emphasis>In a multi-server environment, you must add any modifications to <filename>~/.bashrc</filename> to the top of the file <emphasis>before</emphasis> the line <literal>[ -z "$PS1" ] &amp;&amp; return </literal>. This will allow headless (scripted) logins to load the correct environment.</emphasis>
					</para>
				</note>
				<figure>
					<title>Commands to modify the OpenSRF environment</title>
					<screen>
					# change permissions
					$ su - opensrf
					$ chmod 755 /openils/var/cgi-bin/*.cgi
	
					# add environmental variable
					$ echo "export PERL5LIB=/openils/lib/perl5:\$PERL5LIB" >> ~/.bashrc
	
					# inherit the new environment
					$ . ~/.bashrc
					</screen>
				</figure>
			</section>
			<section xml:id="serversideinstallation-localization">
				<title>(OPTIONAL) Enabling and Disabling Language Localizations</title>
				<para>Current versions of Evergreen (after version 1.4) are bundled with support for a number of languages beyond American English (<emphasis role="bold">en-US</emphasis>). The translated interfaces are split between static files that are automatically installed with Evergreen, and dynamic labels that can be stored in the Evergreen database. Evergreen is installed with additional SQL files that contain translated dynamic labels for a number of languages, and to make the set of translated labels available in all interfaces. Only a few steps are required to enable or disable one or more languages.</para>
				<section>
					<title>Enabling a Localization</title>
					<para>To enable the translated labels for a given language to display in Evergreen, just populate the database with the translated labels and enable the localization. The following example illustrates how to enable Canadian French (<emphasis role="bold">fr-CA</emphasis>) support in the database. These same steps can be used with any of the languages bundled with Evergreen, or you can create and add your own localization.</para>
					<orderedlist>
						<listitem>
							<para>The translated labels for each locale are stored in SQL files named "950.data.seed-values-xx-YY.sql" where "xx-YY" represents the locale code for the translation. Load the translated labels into the Evergreen database using the command <command>psql</command>, substituting your user, host and database connection information accordingly:</para>
							<figure>
								<title>Commands to load localizations into database</title>
								<programlisting language="xml"><![CDATA[
								$ psql -U <username> -h <hostname> -d <database> -f /path/to/Evergreen-source/Open-ILS/src/sql/Pg/950.data.seed-values-fr-CA.sql
								]]></programlisting>
							</figure>
						</listitem>
						<listitem>
							<para>Ensure the locale is enabled in the Evergreen database by using the utility <command>psql</command> to check for the existence of the locale in the table <literal>config.i18n_locale</literal>:</para>
							<figure>
								<title>Commands to check for localization</title>
								<screen>
								SELECT code, marc_code, name, description
								FROM config.i18n_locale
								WHERE code = 'fr-CA';
								</screen>
							</figure>
							<para>As shown in the following example, if one row of output is returned, then the locale is already enabled:</para>
							<figure>
								<title>Results of an installed localization</title>
								<screen>
								code  | marc_code |      name       |   description   
								------+-----------+-----------------+-----------------
								fr-CA | fre       | French (Canada) | Canadian French
								(1 row)
								</screen>
							</figure>
							<para>If zero rows of output are returned, then the locale is not enabled:</para>
							<figure>
								<title>Results of no installed localizations</title>
								<screen>
								code | marc_code | name | description 
								------+-----------+------+-------------
								(0 rows)
								</screen>
							</figure>
							<para>To enable a locale, use <command>psql</command> to insert a row into the table <literal>config.i18n_locale</literal> as follows:</para>
							<figure>
								<title>Commands to enable a locale in the database</title>
								<screen>
								INSERT INTO config.i18n_locale (code, marc_code, name, description)
								VALUES ('fr-CA', 'fre', 'French (Canada)', 'Canadian French');
								</screen>
							</figure>
						</listitem>
					</orderedlist>
				</section>
				<section>
					<title>Disabling a Localization</title>
					<para>You might not want to offer all of the localizations that are preconfigured in Evergreen. If you choose to disable the dynamic labels for a locale, just delete those entries from the table <literal>config.i18n_locale</literal> using the <command>psql</command> utility:</para>
					<figure>
						<title>Commands to delete localization from table</title>
						<screen>
						DELETE FROM config.i18n_locale
						WHERE code = 'fr-CA';
						</screen>
					</figure>
				</section>
			</section>
			<section xml:id="serversideinstallation-starting">
				<title>Starting Evergreen</title>
				<procedure>
					<step>
						<para>As the <systemitem class="username">root</systemitem> user, start the <systemitem class="service">ejabberd</systemitem> and <systemitem class="service">memcached</systemitem> services (if they are not already running):</para>
						<figure>
							<title>Commands to start <systemitem class="service">ejabberd</systemitem> and <systemitem class="service">memcached</systemitem> services</title>
							<screen>
							$ su - root
							$ /etc/init.d/ejabberd start
							$ /etc/init.d/memcached start
							</screen>
						</figure>
					</step>
					<step>
						<para>As the <systemitem class="username">opensrf</systemitem> user, start Evergreen.</para>
						<para>Use the flag <emphasis>-l</emphasis> to force Evergreen to use <emphasis>localhost</emphasis> (your current system) as the hostname. Using the <emphasis>start_all</emphasis> option will start the OpenSRF router, Perl services, and C services:</para>
						<figure>
							<title>Commands to start Evergreen</title>
							<screen>
							$ su - opensrf

							# ensure you have the needed path
							$ export PATH=$PATH:/openils/bin

							# start the OpenSRF service:
							# use "-l" to force hostname to be "localhost"
							$ osrf_ctl.sh -l -a start_all     
							</screen>
						</figure>
						<note>
							<para>
								<emphasis>You can also start Evergreen <emphasis role="bold">without</emphasis> the <option>-l</option> flag, but the <command>osrf_ctl.sh</command> utility must know the fully qualified domain name for the system on which it will execute. That hostname may have been specified in the configuration file <filename>opensrf.xml</filename>, which you configured in a previous step.</emphasis>
							</para>
							<para>Execute the following command to determine the fully qualified domain name of your system:</para>
							<figure>
								<title>(OPTIONAL) Commands to determine the fully qualified domain name</title>
								<screen>
								$ perl -e 'use Net::Domain qw(hostfqdn); print hostfqdn()."\n"'
								</screen>
							</figure>
						</note>
						<indexterm>
							<primary>ZZZ-REVIEW</primary>
							<secondary>ADD EXPLANATION FOR CONFIGURING "opensrf.xml" </secondary>
						</indexterm>
						<caution>ADD EXPLANATION FOR CONFIGURING "opensrf.xml" </caution>
						<itemizedlist>
							<listitem>
								<para>If you receive an error message similar to <emphasis>osrf_ctl.sh: command not found</emphasis>, then your environment variable <envar>PATH</envar> does not include the directory <filename class="directory">/openils/bin</filename>. As the <systemitem class="username">opensrf</systemitem> user, edit the configuration file <filename>/home/opensrf/.bashrc</filename> and add the following line: <literal>export PATH=$PATH:/openils/bin</literal></para>
							</listitem>
							<listitem>
								<para>If you receive an error message similar to <emphasis>Can't locate OpenSRF/System.pm in @INC ... BEGIN failed--compilation aborted</emphasis>, then your environment variable <emphasis role="bold">PERL5LIB</emphasis> does not include the directory <filename class="directory">/openils/lib/perl5</filename>. As the <systemitem class="username">opensrf</systemitem> user, edit the configuration file <filename>/home/opensrf/.bashrc</filename> and add the following line: <literal>export PERL5LIB=$PERL5LIB:/openils/lib/perl5</literal></para>
							</listitem>
						</itemizedlist>
					</step>
					<step>
						<para>As the <systemitem class="username">opensrf</systemitem> user, generate the Web files needed by the Staff Client and catalogue, and calculate the proximity of locations in the Organizational Unit tree (which allows <emphasis>Holds</emphasis> to work properly).</para>
						<para>You must do this the first time you start Evergreen, and after making any changes to the library hierarchy in the configuration file <filename>config.cgi</filename>.</para>
						<figure>
							<title>Commands to generate web files</title>
							<screen>
							$ su - opensrf
							$ cd /openils/bin
							$ ./autogen.sh -c /openils/conf/opensrf_core.xml -u
							Updating Evergreen organization tree and IDL using '/openils/conf/opensrf_core.xml'
							Updating fieldmapper
							...
							</screen>
						</figure>
						<indexterm>
							<primary>ZZZ-REVIEW</primary>
							<secondary>ADD RESULTS OF TESTS FROM "autogen.sh" </secondary>
						</indexterm>
						<caution>ADD RESULTS OF TESTS FROM <filename>autogen.sh</filename> </caution>
					</step>
					<step>
						<para>As the <systemitem class="username">root</systemitem> user, restart the Apache Web server:</para>
						<figure>
							<title>Commands to restart Apache web server</title>
							<screen>
							$ su - root
							$ /etc/init.d/apache2 restart
							</screen>
						</figure>
						<note>If the Apache Web server was running when you started the OpenSRF services, you might not be able to successfully log in to the OPAC or Staff Client until the Apache Web server is restarted.</note>
					</step>
				</procedure>
			</section>
			<section xml:id="serversideinstallation-testing">
				<title>Testing the Installation</title>
				<para>This section describes several simple tests you can perform to verify that the Evergreen server-side software has been installed and configured properly and is running as expected.</para>
				<section xml:id="serversideinstallation-testing-connections">
					<title>Testing Connections to Evergreen</title>
					<para>Once you have installed and started Evergreen, test your connection to Evergreen. As the <systemitem class="username">opensrf</systemitem> user start the <application>srfsh</application> application and try logging onto the Evergreen server using the default administrator username and password. Following is sample output generated by executing that script after a successful Evergreen installation:</para>
					<figure>
						<title>Commands to test Evergreen with <application>srfsh</application></title>
						<screen>
						$ su - opensrf
						$ /openils/bin/srfsh
						srfsh% login admin open-ils
						Received Data: "250bf1518c7527a03249858687714376"
						------------------------------------
						Request Completed Successfully
						Request Time in seconds: 0.045286
						------------------------------------
						Received Data: {
						   "ilsevent":0,
						   "textcode":"SUCCESS",
						   "desc":" ",
						   "pid":21616,
						   "stacktrace":"oils_auth.c:304",
						   "payload":{
						      "authtoken":"e5f9827cc0f93b503a1cc66bee6bdd1a",
						      "authtime":420
						   }
						}
						------------------------------------
						Request Completed Successfully
						Request Time in seconds: 1.336568
						------------------------------------
						</screen>
					</figure>
				</section>
				<section>
					<title>Other Connection Tests with <application>srfsh</application></title>
					<para></para>
					<para>There is another <application>srfsh</application> command called <command>math_bench</command> that sends queries to the math servers. Note that the <systemitem class="service">opensrf.math</systemitem> and <systemitem class="service">opensrf.dbmath</systemitem> must be running for this command to work:</para>
					<figure>
						<title>Example of math_bench usage</title>
						<screen>
						srfsh# math_bench 10
						|.........|.........|.........|.........|.........|.........|.........|.........|.........|.........
						++++++++++++++++++++++++++++++++++++++++
						Average round trip time: 0.033425
						srfsh#
						</screen>
					</figure>
					<para>The first argument is how many sets of 4 queries (+ - * /) are sent to <systemitem class="service">opensrf.math</systemitem>. When the response is successful, you will see the string of <literal>+</literal> symbols. If the system is not running correctly, you will either get an exception or no result at all.</para>
					<para>For other <application>srfsh</application> commands, type <userinput>help</userinput> in at the prompt.</para>
					<para/>
					<para>If this does not work, try the troubleshooting steps in the following section.</para>
				</section>
				<section>
					<title>Testing with <application>settings-tester.pl</application></title>
					<para>As the <systemitem class="username">opensrf</systemitem> user, run the script <command>settings-tester.pl</command> to see if it finds any system configuration problems. Following is sample output generated by executing that script after a successful Evergreen installation:</para>
					<section>
						<title>Example of execution of <command>settings-tester.pl</command></title>
						<programlisting language="xml"><![CDATA[
						$ su - root
						$ cd /home/opensrf/Evergreen-ILS-1.6.0.0
						$ perl Open-ILS/src/support-scripts/settings-tester.pl
						LWP::UserAgent version 5.810
						XML::LibXML version 1.70
						XML::LibXML::XPathContext version 1.70
						XML::LibXSLT version 1.70
						Net::Server::PreFork version 0.97
						Cache::Memcached version 1.24
						Class::DBI version 0.96
						Class::DBI::AbstractSearch version 0.07
						Template version 2.19
						DBD::Pg version 2.8.2
						Net::Z3950::ZOOM version 1.24
						MARC::Record version 2.0.0
						MARC::Charset version 1.1
						MARC::File::XML version 0.92
						Text::Aspell version 0.04
						CGI version 3.29
						DateTime::TimeZone version 0.7701
						DateTime version 0.42
						DateTime::Format::ISO8601 version 0.06
						DateTime::Format::Mail version 0.3001
						Unix::Syslog version 1.1
						GD::Graph3d version 0.63
						JavaScript::SpiderMonkey version 0.19
						Log::Log4perl version 1.16
						Email::Send version 2.192
						Text::CSV version 1.06
						Text::CSV_XS version 0.52
						Spreadsheet::WriteExcel::Big version 2.20
						Tie::IxHash version 1.21
						Parse::RecDescent version 1.95.1
						SRU version 0.99
						JSON::XS version 2.27

						Checking Jabber connection for user opensrf, domain private.localhost
						* Jabber successfully connected
						
						Checking Jabber connection for user opensrf, domain public.localhost
						* Jabber successfully connected
						
						Checking Jabber connection for user router, domain public.localhost
						* Jabber successfully connected
						
						Checking Jabber connection for user router, domain private.localhost
						* Jabber successfully connected
						]]></programlisting>
						<programlisting language="xml"><![CDATA[
						Checking database connections
						* /opensrf/default/reporter/setup :: Successfully connected to database dbi:Pg:dbname=evergreen;host=localhost;port=5432
						  * Database has the expected server encoding UTF8.
						* /opensrf/default/apps/open-ils.storage/app_settings/databases :: Successfully connected to database dbi:Pg:dbname=evergreen;host=localhost;port=5432
						  * Database has the expected server encoding UTF8.
						* /opensrf/default/apps/open-ils.cstore/app_settings :: Successfully connected to database dbi:Pg:dbname=evergreen;host=localhost;port=5432
						  * Database has the expected server encoding UTF8.
						* /opensrf/default/apps/open-ils.pcrud/app_settings :: Successfully connected to database dbi:Pg:dbname=evergreen;host=localhost;port=5432
						  * Database has the expected server encoding UTF8.
						* /opensrf/default/apps/open-ils.reporter-store/app_settings :: Successfully connected to database dbi:Pg:dbname=evergreen;host=localhost;port=5432
						  * Database has the expected server encoding UTF8.
						
						Checking database drivers to ensure <driver> matches <language>
						* OK: Pg language is undefined for reporter base configuration
						* OK: Pg language is undefined for reporter base configuration
						* OK: Pg language is perl in /opensrf/default/apps/open-ils.storage/language
						* OK: pgsql language is C in /opensrf/default/apps/open-ils.cstore/language
						* OK: pgsql language is C in /opensrf/default/apps/open-ils.pcrud/language
						* OK: pgsql language is C in /opensrf/default/apps/open-ils.reporter-store/language
						
						Checking libdbi and libdbi-drivers
						  * OK - found locally installed libdbi.so and libdbdpgsql.so in shared library path
						
						Checking hostname
						 * OK: found hostname 'localhost' in <hosts> section of opensrf.xml
						$
						]]></programlisting>
					</section>
					<para>If the output from the script does not help you find the problem, please do not make any further significant changes to your configuration. Follow the steps in the troubleshooting guide in <xref linkend="troubleshooting"/>.</para>
					<para>If you have followed the entire set of installation steps listed here closely, you are probably extremely close to a working system. Gather your configuration files and log files and contact the <ulink url="http://open-ils.org/listserv.php">Evergreen development mailing list</ulink> for assistance before making any drastic changes to your system configuration.</para>
				</section>
				<section xml:id="serversideinstallation-testing-opac">
					<title>Testing the Catalog</title>
					<para>By default, the OPAC will live at the URL <uri>http://my.domain.com/opac/</uri>.</para>
					<para>Navigate to this URL and the front page of the OPAC should load. There is a basic text entry field with some extra search options. If you have any problems loading this page, check the Apache error logs. If the page loads but does not function correctly, then check for possible javascript errors. We hightly reccommend testing with the <application>Firefox</application> browser because of the helpful javascript debugging tools.</para>
					<para>Assuming that the OPAC is functioning and there is data in your database, you can now perform other simple functional tests (e.g., searching the catalog).</para>
					<indexterm>
						<primary>ZZZ-REVIEW</primary>
						<secondary>ADD OTHER SIMPLE FUNCTIONAL TESTS </secondary>
					</indexterm>
					<caution>ADD OTHER SIMPLE FUNCTIONAL TESTS </caution>
				</section>
				<section>
					<title>Running the Evergreen Staff Client</title>
					<para>Run the Evergreen Staff Client by using the application <application>XULRunner</application> (installed automatically and by default with Firefox version 3.0 and later on <systemitem class="osname">Ubuntu</systemitem> and <systemitem class="osname">Debian</systemitem> distributions).</para>
					<para>For example, if the source files for the Evergreen installation are in the directory <filename class="directory">/home/opensrf/Evergreen-ILS-1.6.0.7/</filename>, start the Staff Client as follows:</para>
					<figure>
						<title>Commands to run the Staff Client</title>
						<screen>
						$ su - opensrf
						$ xulrunner /home/opensrf/Evergreen-ILS-1.6.0.7/Open-ILS/xul/staff_client/build/application.ini
						</screen>
					</figure>
				</section>
				<section xml:id="serversideinstallation-starting-apache-server">
					<title>Testing the Apache Web Server</title>
					<para>Once you have started Evergreen and confirmed that a basic login attempt works, you can test and start the Apache web server.</para>
					<para>As the <systemitem class="username">root</systemitem> user, execute the following commands. Note the use of <emphasis>restart</emphasis> to force the new Evergreen modules to be reloaded even if the Apache server is already running. Any problems found with your configuration files should be displayed:</para>
					<figure>
						<title>Commands to test the Apache Web Server</title>
						<screen>
						$ su - root
						$ apache2ctl configtest &amp;&amp; /etc/init.d/apache2 restart
						</screen>
					</figure>
				</section>
			</section>
			<section xml:id="serversideinstallation-stopping">
				<title>Stopping Evergreen</title>
				<para>As the <systemitem class="username">opensrf</systemitem> user, stop all Evergreen services by using the following command:</para>
				<figure>
					<title>Commands to stop Evergreen</title>
					<screen>
					$ su - opensrf

					# stop the server:
					# use "-l" to force hostname to be "localhost"
					$ osrf_ctl.sh -l -a stop_all
					</screen>
				</figure>
				<note>
					<para>
						<emphasis>You can also stop Evergreen services <emphasis role="bold">without</emphasis> the <option>-l</option> flag, but the <command>osrf_ctl.sh</command> utility must know the fully qualified domain name for the system on which it will execute. That hostname may have been specified in the configuration file <filename>opensrf.xml</filename>, which you configured in a previous step.</emphasis>
					</para>
				</note>
				<indexterm>
					<primary>ZZZ-REVIEW</primary>
					<secondary>ADD EXPLANATION FOR CONFIGURING "opensrf.xml" </secondary>
				</indexterm>
				<caution>ADD EXPLANATION FOR CONFIGURING "opensrf.xml" </caution>
			</section>
			<section xml:id="serversideinstallation-postinstallation">
				<title>Post-Installation Chores</title>
				<para>There are a few additional steps to complete after Evergreen has been successfully installed and tested.</para>
				<section>
					<title>Remove temporary changes from Apache configuration file</title>
					<para>As the <systemitem class="username">root</systemitem> user, edit the Apache configuration file <filename>/etc/apache2/sites-available/eg.conf</filename> again and make the following change:</para>
					<para>Uncomment the line <literal>Allow from 10.0.0.0/8</literal>, then comment out the line <literal>Allow from all</literal>. You modified this file in an earlier step as a temporary measure to expedite testing (see <xref linkend="serversideinstallation-modify-apache"/> for further information). Those changes must now be reversed in order to deny unwanted access to your CGI scripts from users on other public networks. You <emphasis role="bold">must</emphasis> secure this for a public production system.</para>
				</section>
				<section>
					<title>Configure a permanent SSL key</title>
					<para>In a previous step, we used the command <command>openssl</command> to temporarily create a new SSL key for the Apache server. For a public production server you should configure or purchase a signed SSL certificate. For further information on getting a proper SSL certificate, see <xref linkend="serversideinstallation-ssl"/>.</para>
					<warning>
						<para>
							<emphasis>The temporary SSL key was only created to expedite testing. You <emphasis role="bold"> must</emphasis> get a proper SSL certificate for a public production system.</emphasis>
						</para>
					</warning>
				</section>
				<section>
					<title>Set Up Support For Reports</title>
					<para>Evergreen reports are extremely powerful, but some configuration is required. See <xref linkend="report-introduction"/> for details.</para>
					<itemizedlist>
						<listitem>
							<para>Starting the Reporter Daemon</para>
							<para>Once the <systemitem class="daemon">open-ils.reporter</systemitem> process is running and enabled on the gateway, you can start the reporter daemon. That process periodically checks for requests for new reports or scheduled reports and gets them running.</para>
							<para>As the <systemitem class="username">opensrf</systemitem> user, start the reporter daemon using the following command:</para>
							<figure>
								<title>Commands to start the Reporter daemon</title>
								<screen>
								$ su - opensrf
								$ cd /home/opensrf/Evergreen-ILS-1.6.0.7/Open-ILS/src/reporter
								$ ./clark-kent.pl --daemon
								</screen>
							</figure>
							<para>You can also specify other options with this utility:</para>
							<itemizedlist>
								<listitem><option>--sleep=interval</option> : number of seconds to sleep between checks for new reports to run; defaults to 10</listitem>
								<listitem><option>--lockfile=filename</option> : where to place the lockfile for the process; defaults to <filename>/tmp/reporter-LOCK</filename></listitem>
								<listitem><option>--concurrency=integer</option> : number of reporter daemon processes to run; defaults to <literal>1</literal></listitem>
								<listitem><option>--bootstrap=filename</option> : OpenSRF bootstrap configuration file; defaults to <filename>/openils/conf/opensrf_core.xml</filename></listitem>
							</itemizedlist>
						</listitem>
						<listitem>
							<para>Stopping the Reporter Daemon</para>
							<para>To stop the Reporter daemon, you must kill the process and remove the lockfile. The daemon may have just a single associated process, with a lockfile in the default location.</para>
							<note>
								<para>
									<emphasis>It is possible that several processes are running; see the optional commands in the previous section. As the <systemitem class="username">opensrf</systemitem> user, perform the following commands to stop the Reporter daemon:</emphasis>
								</para>
							</note>
							<figure>
								<title>Commands to stop the Reporter daemon</title>
								<screen>
								$ su - opensrf
								# find and kill the process ID number(s)
								$ kill `ps wax | grep "Clark Kent" | grep -v grep | cut -b1-6`
								# remove the lock file
								$ rm /tmp/reporter-LOCK
								</screen>
							</figure>
						</listitem>
					</itemizedlist>
				</section>
				<section xml:id="serversideinstallation-organizationandpolicy">
					<title>Organization and Policy Editing</title>
					<para>After installing Evergreen, you will want to make configuration changes to reflect the organizational hierarchy and the policies of your library or libraries. See <xref linkend="serveradministration-orgunits"/> for further information. Examples of what can be configured include:</para>
					<itemizedlist>
						<listitem>Adding a branch library</listitem>
						<listitem>Changing circulation rules for an existing library</listitem>
						<listitem>Adding a new staff position or user group</listitem>
					</itemizedlist>
					<indexterm>
						<primary>ZZZ-REVIEW</primary>
						<secondary>ADD CONTENT FOR ORGANIZATION AND POLICY EDITING </secondary>
					</indexterm>
					<caution>ADD CONTENT FOR ORGANIZATION AND POLICY EDITING </caution>
				</section>
			</section>
		</section>
		<section xml:id="serversideinstallation-virtual">
			<title>Installing In Virtualized Unix Environments</title>
			<para>Evergreen software currently runs as a native application on any of several well-known <systemitem class="osname">Linux</systemitem> distributions (e.g., <systemitem class="osname">Ubuntu</systemitem> and <systemitem class="osname">Debian</systemitem>). It does not run as a native application on the <systemitem class="osname">Windows</systemitem> operating system (e.g., <systemitem class="osname">WindowsXP</systemitem>, <systemitem class="osname">WindowsXP Professional</systemitem>, <systemitem class="osname">Windows7</systemitem>), but the software can be installed and run on <systemitem class="osname">Windows</systemitem> via a virtualized Unix-guest Operating System (using, for example, <application>VirtualBox</application> or <application>VMware</application> to emulate a <systemitem class="osname">Linux</systemitem> environment).</para>
			<indexterm>
				<primary>ZZZ-REVIEW</primary>
				<secondary>ADD CONTENT FOR INSTALLING EVERGREEN IN VIRTUALIZED UNIX ENVIRONMENTS </secondary>
			</indexterm>
			<caution>ADD CONTENT FOR INSTALLING EVERGREEN IN VIRTUALIZED UNIX ENVIRONMENTS </caution>
			<section xml:id="serversideinstallation-virtualized-virtualbox">
				<title>VirtualBox</title>
				<indexterm>
					<primary>ZZZ-REVIEW</primary>
					<secondary>ADD CONTENT FOR VirtualBox </secondary>
				</indexterm>
				<caution>ADD CONTENT FOR VirtualBox </caution>
			</section>
			<section xml:id="serversideinstallation-virtualized-vmware">
				<title>VMware</title>
				<indexterm>
					<primary>ZZZ-REVIEW</primary>
					<secondary>ADD CONTENT FOR VMware </secondary>
				</indexterm>
				<caution>ADD CONTENT FOR VMware </caution>
			</section>
			<section xml:id="serversideinstallation-virtualized-virtualpc">
				<title>VirtualPC</title>
				<indexterm>
					<primary>ZZZ-REVIEW</primary>
					<secondary>ADD CONTENT FOR VirtualPC </secondary>
				</indexterm>
				<caution>ADD CONTENT FOR VirtualPC </caution>
			</section>
		</section>
		<section xml:id="serversideinstallation-previousversions">
			<title>Installing Previous Versions of Evergreen</title>
			<para>Earlier releases of Evergreen are available. Instructions for installing, configuring and testing earlier versions are found below.</para>
			<para>The next most recent previous release of Evergreen is version <emphasis><emphasis role="bold">1.4.0.6</emphasis></emphasis>. The accompanying previous release of OpenSRF is version <emphasis><emphasis role="bold">1.0.x</emphasis></emphasis>.</para>
			<section xml:id="serversideinstallation-evergreen-previous">
				<title>Installing Evergreen 1.4.x.x On <systemitem class="osname">Ubuntu</systemitem> or <systemitem class="osname">Debian</systemitem></title>
				<para>This section outlines the installation process for the previous version 1.4.0.6 of Evergreen.</para>
				<para>In this section you will download, unpack, install, configure and test the Evergreen system, including the Evergreen server and the PostgreSQL database system. You will make several configuration changes and adjustments to the software, including updates to configure the system for your own locale, and some updates needed to work around a few known issues.</para>
				<note>
					<para>The following steps have been tested on the x86 (32-bit) and x86-64 (64-bit) architectures. There may be differences between the Desktop and Server editions of <systemitem class="osname">Ubuntu</systemitem>. These instructions assume the Server edition.</para>
					<para>If you are starting with a clean install of <systemitem class="osname">Ubuntu</systemitem> or <systemitem class="osname">Debian</systemitem>, you are strongly recommended <emphasis role="bold">not</emphasis> to install the packaged PostgreSQL server. This can confuse port numbers and system configuration. Evergreen 1.4 requires PostgreSQL 8.2.</para>
				</note>
				<section>
					<title>Installing OpenSRF</title>
					<para>Evergreen software is integrated with and depends on the Open Service Request Framework (OpenSRF) software system. For further information on installing, configuring and testing OpenSRF, see <xref linkend="serversideinstallation-opensrf-previous"/>.</para>
					<para>Follow the steps outlined in that section and run the specified tests to ensure that OpenSRF is properly installed and configured. Do not continue with any further Evergreen installation steps until you have verified that OpenSRF has been successfully installed.</para>
				</section>
				<section>
					<title>Download and Unpack Evergreen Version 1.4.0.6</title>
					<para>As the <systemitem class="username">opensrf</systemitem> user, download and extract the latest version of Evergreen. The latest version can be found here: <ulink url="http://evergreen-ils.org/downloads/Evergreen-ILS-1.4.0.6.tar.gz"></ulink></para>
					<figure>
						<title>Commands to download and unpack Evergreen</title>
						<screen>
						$ su - opensrf
						$ wget http://evergreen-ils.org/downloads/Evergreen-ILS-1.4.0.6.tar.gz
						$ tar zxf Evergreen-ILS-1.4.0.6.tar.gz
						</screen>
					</figure>
					<para>The new directory <filename class="directory">/home/opensrf/Evergreen-ILS-1.4.0.6</filename> will be created.</para>
				</section>
				<section>
					<title>Install Prerequisites to Build Evergreen</title>
					<para>In this section you will install and configure a set of prerequisites that will be used to build Evergreen. In a following step you will actually build the software using the <command>make</command> utility.</para>
					<para>As the <systemitem class="username">root</systemitem> user, enter the commands show below to build the prerequisites from the software distribution that you just downloaded and unpacked. Remember to replace <emphasis>[distribution]</emphasis> in the example with the keyword corresponding to the actual <systemitem class="osname">Linux</systemitem> distribution listed in the <link linkend="serversideinstallation-keywords-figure-2-a">"Keywords"</link> figure below.</para>
					<figure>
						<title>Commands to install prerequisites for Evergreen</title>
						<screen>
						$ su - root
						$ cd /home/opensrf/Evergreen-ILS-1.4.0.6
						$ make -f Open-ILS/src/extras/Makefile.install [distribution]
						...
						</screen>
					</figure>
					<table xml:id="serversideinstallation-keywords-figure-2-a">
						<title>Keywords Targets for <application>make</application></title>
						<tgroup align="left" cols="2" colsep="1" rowsep="1">
							<colspec colnum="1" colwidth="1*"/>
							<colspec colnum="2" colwidth="3*"/>
							<thead>
								<row>
									<entry>Keyword</entry>
									<entry>Description</entry>
								</row>
							</thead>
							<tbody>
								<row>
									<entry>debian-lenny</entry>
									<entry>for Debian Lenny (5.0)</entry>
								</row>
								<row>
									<entry>debian-etch</entry>
									<entry>for Debian Etch (4.0)</entry>
								</row>
								<row>
									<entry>ubuntu-intrepid</entry>
									<entry>for Ubuntu Intrepid (8.10)</entry>
								</row>
								<row>
									<entry>ubuntu-hardy</entry>
									<entry>for Ubuntu Hardy (8.04)</entry>
								</row>
							</tbody>
						</tgroup>
					</table>
				</section>
				<section>
					<title>Update the System Dynamic Library Path</title>
					<para>As the <systemitem class="username">root</systemitem> user, you must update the system dynamic library path to make your system recognize the newly installed libraries. Do this by creating the new file <filename>/etc/ld.so.conf.d/eg.conf</filename> containing two new library paths, then run the command <command>ldconfig</command> to automatically read the file and modify the system dynamic library path:</para>
					<figure>
						<title>Commands to modify system dynamic library path</title>
						<screen>
						$ su - root
						$ cat > /etc/ld.so.conf.d/eg.conf &lt;&lt; ENDOFFILE
						/usr/local/lib
						/usr/local/lib/dbd
						ENDOFFILE
						$ ldconfig
						</screen>
					</figure>
				</section>
				<section>
					<title>Restart the PostgreSQL Server</title>
					<para>If PostgreSQL is running on the same system as the rest of Evergreen, as the <systemitem class="username">root</systemitem> user you must restart the PostgreSQL server to avoid a problem where the library <filename>plperl.so</filename> cannot be found. If your PostgreSQL server is running on another system, just skip this step.</para>
					<figure>
						<title>Commands to restart PostgreSQL server</title>
						<screen>
						$ su - root
						$ /etc/init.d/postgresql-8.2 restart
						</screen>
					</figure>
				</section>
				<section>
					<title>Configure Evergreen</title>
					<para>As the <systemitem class="username">opensrf</systemitem> user, return to the Evergreen build directory and use the <command>configure</command> utility to prepare for the next step of compiling and linking the software:</para>
					<figure>
						<title>Commands to configure Evergreen</title>
						<screen>
						$ su - opensrf
						$ cd /home/opensrf/Evergreen-ILS-1.4.0.6
						$ ./configure --prefix=/openils --sysconfdir=/openils/conf
						$ make
						...
						</screen>
					</figure>
				</section>
				<section>
					<title>Compile, Link and Install Evergreen</title>
					<para>In this step you will actually compile, link and install Evergreen and the default Evergreen Staff Client.</para>
					<para>As the <systemitem class="username">root</systemitem> user, return to the Evergreen build directory and use the <command>make</command> utility as shown below. The Staff Client will also be automatically built, but you must remember to set the variable <envar>STAFF_CLIENT_BUILD_ID</envar> to match the version of the Staff Client you will use to connect to the Evergreen server.</para>
					<para>For further information on manually building the Staff Client, see <xref linkend="serversideinstallation-building-staffclient"/>.</para>
					<figure>
						<title>Commands to build, link and install Evergreen</title>
						<screen>
						$ su - root
						$ cd /home/opensrf/Evergreen-ILS-1.4.0.6
						$ make STAFF_CLIENT_BUILD_ID=rel_1_4_0_6 install
						...
						</screen>
						<para>The above commands will create a new subdirectory <filename class="directory">/openils/var/web/xul/rel_1_4_0_6</filename> containing the Staff Client.</para>
					</figure>
				</section>
				<section>
					<title>Copy the OpenSRF Configuration Files</title>
					<para>As the <systemitem class="username">root</systemitem> user, copy the example OpenSRF configuration files into place. This replaces the configuration files that you set up in a previous step when you installed and tested OpenSRF. You should also create backup copies of the old files for troubleshooting purposes. Finally, change the ownership on the installed files to the <systemitem class="username">opensrf</systemitem> user:</para>
					<figure>
						<title>Commands to copy OpenSRF configuration files</title>
						<screen>
						$ su - root
						$ cp /openils/conf/opensrf.xml.example      /openils/conf/opensrf.xml
						$ cp /openils/conf/opensrf_core.xml.example /openils/conf/opensrf_core.xml
						$ chown -R opensrf:opensrf /openils/
						</screen>
					</figure>
				</section>
				<section>
					<title>Create and Configure PostgreSQL Database</title>
					<para>As the <systemitem class="username">postgres</systemitem> user on your PostgreSQL server, create the Evergreen database.</para>
					<para>In the commands below, remember to adjust the path of the <emphasis role="bold">contrib</emphasis> repository to match your PostgreSQL server layout. For example, if you built PostgreSQL from source the path would be <filename class="directory">/usr/local/share/contrib</filename>; if you installed the PostgreSQL 8.2 server packages on <systemitem class="osname">Ubuntu 8.04</systemitem>, the path would be <filename class="directory">/usr/share/postgresql/8.2/contrib/</filename>.</para>
					<procedure>
						<step>
							<para>
								<emphasis role="bold">Create and configure the database</emphasis>
							</para>
							<para>As the <systemitem class="username">postgres</systemitem> user on the PostgreSQL system create the PostgreSQL database, then set some internal paths:</para>
							<figure>
								<title>Commands to create database and adjust the path</title>
								<screen>
								# create the database
								$ su - postgres
								$ createdb -E UNICODE evergreen
								$ createlang plperl   evergreen
								$ createlang plperlu  evergreen
								$ createlang plpgsql  evergreen
			
								# adjust the paths
								$ psql -f /usr/share/postgresql/PGSQL_VERSION/contrib/tablefunc.sql evergreen
								$ psql -f /usr/share/postgresql/PGSQL_VERSION/contrib/tsearch2.sql  evergreen
								$ psql -f /usr/share/postgresql/PGSQL_VERSION/contrib/pgxml.sql     evergreen
								</screen>
							</figure>
							<emphasis>Where <literal>PGSQL_VERSION</literal> is your installed PostgreSQL version (e.g. <literal>8.2</literal>).</emphasis>
						</step>
						<step>
							<para>
								<emphasis role="bold">Create new Evergreen superuser</emphasis>
							</para>
							<para>As the <systemitem class="username">postgres</systemitem> user on the PostgreSQL system, create the new database <systemitem class="username">evergreen</systemitem> user and assign a password:</para>
							<figure>
								<title>Commands to create the <systemitem class="username">evergreen</systemitem> user</title>
								<screen>
								# create superuser 'evergreen' and set the password
								$ su - postgres
								$ createuser -P -s evergreen
								Enter password for new role: MYNEWPASSWORD
								Enter it again: MYNEWPASSWORD
								</screen>
							</figure>
							<emphasis>Where <literal>MYNEWPASSWORD</literal> is the password chosen.</emphasis>
						</step>
					</procedure>
				</section>
				<section>
					<title>Create Database Schema</title>
					<para>As the <systemitem class="username">root</systemitem> user, create the database schema and configure your system with the corresponding database authentication details for the <emphasis>evergreen</emphasis> database user that you created in the previous step.</para>
					<para>Enter the following commands and replace <emphasis>HOSTNAME, PORT, PASSWORD</emphasis> and <emphasis>DATABASENAME</emphasis> with appropriate values.</para>
					<figure>
						<title>Commands to create Evergreen database schema</title>
						<screen>
						$ su - root
						$ cd /home/opensrf/Evergreen-ILS-1.4.0.6
						$ perl Open-ILS/src/support-scripts/eg_db_config.pl --update-config \
							--service all --create-schema --create-bootstrap --create-offline \
							--hostname HOSTNAME --port PORT \
							--user evergreen --password PASSWORD --database DATABASENAME
						</screen>
					</figure>
					<emphasis>Where, on most systems, <emphasis>HOSTNAME</emphasis> will be <emphasis role="bold">localhost</emphasis>, <emphasis>PORT</emphasis> will be <emphasis role="bold">5432</emphasis>, and <emphasis>PASSWORD</emphasis> and <emphasis>DATABASENAME</emphasis> will be those assigned when PostgreSQL was installed in the previous step.</emphasis>
					<note>
						<para>
							<emphasis>If you are entering the above command on a single line, do not include the <literal>\</literal> (backslash) characters. If you are using the <command>bash</command> shell, these should only be used at the end of a line at a bash prompt to indicate that the command is continued on the next line.</emphasis>
						</para>
					</note>
				</section>
				<section>
					<title>Modify the Apache Configuration</title>
					<para>The Apache configuration must be updated. See <xref linkend="serversideinstallation-modify-apache"/> for further information.</para>
				</section>
				<section>
					<title>Modify the OpenSRF Configuration File</title>
					<para>The OpenSRF configuration must be modified. See <xref linkend="serversideinstallation-opensrf-config"/> for further information.</para>
				</section>
				<section>
					<title>Create Configuration Files for Users Needing <application>srfsh</application></title>
					<para>Special configuration files are needed for all users who need to use the application <application>srfsh</application> for testing. See <xref linkend="serversideinstallation-srfsh"/> for further information.</para>
				</section>
				<section>
					<title>Modify the OpenSRF Environment</title>
					<para>Several simple changes to the OpenSRF environment are required. See <xref linkend="serversideinstallation-opensrf-env"/> for further information.</para>
				</section>
				<section>
					<title>(OPTIONAL) Enabling and Disabling Language Localizations</title>
					<para>Before starting Evergreen, you can add language localization for a number of languages beyond American English (<emphasis role="bold">en-US</emphasis>). For further information on language localization, see <xref linkend="serversideinstallation-localization"/>.</para>
				</section>
				<section>
					<title>Starting Evergreen</title>
					<para>Start Evergreen according to the instructions in <xref linkend="serversideinstallation-starting"/>.</para>
				</section>
				<section>
					<title>Testing the Installation</title>
					<para>Simple tests can be used to verify that Evergreen server-side software has been installed and configured properly and is running as expected. See <xref linkend="serversideinstallation-testing"/> for further information on testing the latest version of Evergreen. Earlier versions can be tested similarly.</para>
				</section>
				<section>
					<title>Stopping Evergreen</title>
					<para>Stop Evergreen according to the instructions in <xref linkend="serversideinstallation-stopping"/>.</para>
				</section>
				<section>
					<title>Post-Installation Chores</title>
					<para>A few additional steps must be performed after Evergreen has been successfully installed and tested. See <xref linkend="serversideinstallation-postinstallation"/> for the list of final steps.</para>
				</section>
			</section>
			<section xml:id="serversideinstallation-opensrf-previous">
				<title>Installing OpenSRF 1.0.x</title>
				<indexterm>
					<primary>ZZZ-REVIEW</primary>
					<secondary>ADD CONTENT FOR INSTALLING OPENSRF 1.0.x </secondary>
				</indexterm>
				<caution>ADD CONTENT FOR INSTALLING OPENSRF 1.0.x </caution>
			</section>
		</section>
		<section xml:id="serversideinstallation-postgresql">
			<title>Installing PostgreSQL</title>
			<indexterm>
				<primary>ZZZ-REVIEW</primary>
				<secondary>ADD CONTENT FOR POSTGRESQL </secondary>
			</indexterm>
			<caution>ADD CONTENT FOR POSTGRESQL </caution>
		</section>
		<section xml:id="serversideinstallation-apache">
			<title>Installing Apache</title>
			<section>
				<title>Securing Apache (httpd)</title>
				<para>The main consideration is to secure the directory <filename class="directory">cgi-bin</filename>. The only persons that need access to this directory are Evergreen system administrators. This directory should be restricted by both IP (to those workstations designated as Evergeen Administration systems), and by username/password.</para>
				<indexterm>
					<primary>ZZZ-REVIEW</primary>
					<secondary>ADD CONTENT ON HOW TO RESTRICT APACHE BY IP AND USERNAME/PASSWORD </secondary>
				</indexterm>
				<caution>ADD CONTENT ON HOW TO RESTRICT APACHE BY IP AND USERNAME/PASSWORD </caution>
				<para>A user could add new libraries, re-arrange consortia, or change user groups; or a staff member could access the directory, and change his associated security group to administrative level privileges.</para>
			</section>
			<indexterm>
				<primary>ZZZ-REVIEW</primary>
				<secondary>ADD MORE CONTENT FOR APACHE </secondary>
			</indexterm>
			<caution>ADD MORE CONTENT FOR APACHE </caution>
		</section>
	</section>
	<section>
		<title>Installing the Staff Client</title>
		<para>You can install the Staff Client from pre-built images and packages without actually having to first build it. Pre-built packages are currently available for <systemitem class="osname">Windows</systemitem>, <systemitem class="osname">Mac OS X</systemitem>, and <systemitem class="osname">Linux</systemitem>. If you need to manually build the Staff Client, see <xref linkend="serversideinstallation-building-staffclient"/>.</para>
		<section xml:id="serversideinstallation-prebuilt-staffclient">
			<title>Installing a Pre-Built Staff Client</title>
			<para>This section reviews the process of installing pre-built versions of the Staff Client in various environments.</para>
			<section>
				<title>Installing on <systemitem class="osname">Windows</systemitem></title>
				<para>A standard <systemitem class="osname">Windows</systemitem> installer that contains the current version of the Staff Client is available from the downloads section of the Evergreen website at <ulink url="http://www.evergreen-ils.org/downloads.php">http://www.evergreen-ils.org/downloads.php</ulink>. Download the staff client installer, then run it. A screen that looks similar to this should appear:</para>
				<figure>
					<title>Running the Staff Client installer</title>
					<mediaobject>
						<imageobject>
							<imagedata fileref="../media/serversideinstallation-staffclient-1.png" scalefit="1" width="70%"/>
						</imageobject>
					</mediaobject>
				</figure>
				<para>Click <guibutton>Next</guibutton> to continue through the guided install process. The install wizard will ask you to agree to the end-user license, ask you where to install the software, ask about where to place icons, and then will install the software on your workstation.</para>
				<para>When you run the staff client for the first time, a screen similar to this should appear:</para>
				<figure>
					<title>Running the Staff Client for the first time</title>
					<mediaobject>
						<imageobject>
							<imagedata fileref="../media/serversideinstallation-staffclient-2.png" scalefit="1" width="70%"/>
						</imageobject>
					</mediaobject>
				</figure>
				<para>First, configure the server you would like to connect to in the <emphasis role="bold">Server</emphasis> section. For example, the PINES demo system is <systemitem class="domain">demo.gapines.org</systemitem>. After selecting a server, click <guibutton>Re-Test Server</guibutton>.</para>
				<para>Because this is the initial run of the staff client, the <emphasis role="bold">Workstation</emphasis> section in the upper-right states: <emphasis role="bold">Not yet configured for the specified server</emphasis>. The first thing that must be done to the Staff Client on every workstation is to assign it a workstation name. This is covered in <xref linkend="serversideinstallation-workstationnames"/>.</para>
			</section>
			<section>
				<title>Installing on <systemitem class="osname">Mac OS X</systemitem></title>
				<para>A <systemitem class="osname">Mac OS X</systemitem> package that contains the current version of the Staff Client is available for use with <application>xulrunner</application>.</para>
				<section>
					<title>Evergreen Indiana Pkg file [Evergreen v1.2.3.0]</title>
					<procedure>
						<step>Download and install the latest version of <application>xulrunner</application> for <systemitem class="osname">Mac OS X</systemitem>. Release notes for the latest version can be found here: <ulink url="http://developer.mozilla.org/en/docs/XULRunner_1.8.0.4_Release_Notes">http://developer.mozilla.org/en/docs/XULRunner_1.8.0.4_Release_Notes</ulink>. Note, later versions may not work correctly.</step>
						<step>Download and install the <systemitem class="osname">Mac OS X</systemitem> Installation package for the 1_2_3_0 Version Staff Client from <ulink url="http://evergreen.lib.in.us/opac/extras/files/evergreen_osx_staff_client_1_2_3.zip">http://evergreen.lib.in.us/opac/extras/files/evergreen_osx_staff_client_1_2_3.zip</ulink>.</step>
						<step>To upgrade to a more recent version of the staff client, you can copy the directory <emphasis>build</emphasis> from a working <systemitem class="osname">Windows</systemitem> installation of the desired version of the staff client to your Mac. The required files may be located in a directory like this on the <systemitem class="osname">Windows</systemitem> machine: <filename class="directory">C:\Program Files\Evergreen Staff Client\build</filename>. Copy these files into the folder <filename class="directory">Resources</filename> within the Open-ILS package in your Applications directory on the Mac, overwriting files with the same names.</step>
						<step>Drag the application's icon into your toolbar for easier access.</step>
					</procedure>
					<para/>
					<para>When you run the staff client installer, a screen will appear that looks similar to this:</para>
					<figure>
						<title>Running the Staff Client installer</title>
						<mediaobject>
							<imageobject>
								<imagedata fileref="../media/serversideinstallation-staffclient-3.png" scalefit="1" width="20%"/>
							</imageobject>
						</mediaobject>
					</figure>
					<caution> FIX BAD LINK: http://es.zionsville.lib.in.us/atheos/eg_osx_a.gif </caution>
					<para>Click <guibutton>Continue</guibutton>, accept the license, then finish the installation. The application will be located at the destination you selected during installation. You will then be able to drag the application into your toolbar for easier access.</para>
					<figure>
						<title>Finishing the installation</title>
						<mediaobject>
							<imageobject>
								<imagedata fileref="../media/serversideinstallation-staffclient-4.png" scalefit="1" width="20%"/>
							</imageobject>
						</mediaobject>
					</figure>
					<caution> FIX BAD LINK: http://es.zionsville.lib.in.us/atheos/eg_osx_a.gif </caution>
				</section>
				<section>
					<title>Running directly using <application>xulrunner</application></title>
					<para>You must install an apropriate version of <application>xulrunner</application> to match the Evergreen version. See the following table for the recommended version of <application>xulrunner</application>:</para>
					<table>
						<title>Evergreen / XULRunner Dependencies</title>
						<tgroup align="left" cols="2" colsep="1" rowsep="1">
							<colspec colnum="1" colwidth="1*"/>
							<colspec colnum="2" colwidth="3*"/>
							<tbody>
								<row>
									<entry>Evergreen 1.6.x.x</entry>
									<entry>XULrunner 1.9</entry>
								</row>
								<row>
									<entry>Evergreen 1.4.x.x</entry>
									<entry>XULrunner 1.8.0.4 or XULrunner 1.8.0.3</entry>
								</row>
								<row>
									<entry>Evergreen 1.2.x.x</entry>
									<entry>XULrunner 1.8.0.4 or XULrunner 1.8.0.3</entry>
								</row>
							</tbody>
						</tgroup>
					</table>
					<note>If you have issues removing previously installed <application>xulrunner</application> versions see <xref linkend="serversideinstallation-staffclient-remove-xulrunner"/> for information on removing previous <application>XULRunner</application> versions.</note>
					<para>The staff client data from the directory <filename class="directory">./staff_client/build</filename> must be placed somewhere on the machine (e.g. <emphasis>~/Desktop/Evergreen_Staff_Client</emphasis>). Remember to call <application>XULRunner</application> with the full path to the binary, followed by the install command and the path to the client data. See the following command:</para>
					<figure>
						<title>Executing <application>xulrunner</application></title>
						<screen>
						/Library/Frameworks/XUL.framework/xulrunner-bin --install-app ~/Desktop/Evergreen_Staff_Client
						</screen>
					</figure>
					<para>This command should exit quietly. A folder will be created, named <emphasis>/Applications/OpenILS</emphasis>, containing a launcher named <emphasis>open_ils_staff_client</emphasis>.</para>
				</section>
				<section xml:id="serversideinstallation-staffclient-remove-xulrunner">
					<title>Removing previously installed <application>xulrunner</application> versions</title>
					<para>If you already have a newer version installed, per the release notes, you will need to remove the entire directory <filename class="directory">/Library/Frameworks/XUL.framework</filename> before downgrading.</para>
					<para>In addition, you may also need to remove the previous file <filename>/Library/Receipts/xulrunner-ver-mak.pkg</filename>.</para>
					<para>If there is no file <filename>/Library/Receipts/xulrunner-ver-mak.pkg</filename> (possibly in newer OSX releases) you need to flush the file <emphasis>receiptdb</emphasis>.</para>
					<note>If you install a newer version over a previous (older) install, the older one is not removed but the symlinks get changed to the newer one.</note>
					<para>First, get the package identifier, then purge/forget the build that was initially installed:</para>
					<figure>
						<title>Purging previous build</title>
						<screen>
						sudo pkgutil --pkgs > /tmp/pkgs.txt
						sudo pkgutil --forget org.mozilla.xulrunner
						</screen>
					</figure>
					<note>It may not be necessary to edit the file <filename>/Library/Receipts/InstallHistory.plist</filename> after deleting the folder <emphasis>XUL.framework</emphasis>.</note>
				</section>
				<section>
					<title>Creating an APP file: Staff Client &amp; <application>xulrunner</application> Bundled</title>
					<para>An APP file is basically a folder. Start with a folder stucture like this:</para>
					<figure>
						<title>Sample APP file folder structure</title>
						<screen>
						* Evergreen.app
						  * Contents
						    * Frameworks
						    * Resources
						    * MacOS
						</screen>
					</figure>
					<para>Create an APP folder structure with the following commands:</para>
					<figure>
						<title>Creating a folder structure</title>
						<screen>
						mkdir -p Evergreen.app/Contents/Frameworks
						mkdir -p Evergreen.app/Contents/Resources
						mkdir -p Evergreen.app/Contents/MacOS
						</screen>
					</figure>
					<para/>
					<procedure>
						<step>
							<para>Create a new file in the folder <emphasis>Evergreen.app/Contents/Info.plist</emphasis> containing the following data (adjust for your version of Evergreen):</para>
							<figure>
								<title>Creating a new file</title>
								<programlisting language="xml"><![CDATA[
								<?xml version="1.0" encoding="UTF-8"?>
								<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
								<plist version="1.0">
								<dict>
									<key>CFBundleExecutable</key>
									<string>xulrunner</string>
									<key>CFBundleGetInfoString</key>
									<string>OpenILS open_ils_staff_client rel_1_6_0_7</string>
									<key>CFBundleInfoDictionaryVersion</key>
									<string>6.0</string>
									<key>CFBundleName</key>
									<string>Evergreen Staff Client</string>
									<key>CFBundlePackageType</key>
									<string>APPL</string>
									<key>CFBundleShortVersionString</key>
									<string>rel_1_6_0_7</string>
									<key>CFBundleVersion</key>
									<string>rel_1_6_0_7.rel_1_6_0_7</string>
									<key>NSAppleScriptEnabled</key>
									<true/>
									<key>CFBundleTypeIconFile</key>
									<string>Evergreen.icns</string>
								</dict>
								</plist>
								]]></programlisting>
							</figure>
						</step>
						<step>Download and install an appropriate <systemitem class="osname">Mac OS X</systemitem>package of <application>XULRunner</application> from the Mozilla website (see above for recommendations).</step>
						<step>
							<para>Make a copy of <emphasis>/Library/Frameworks/XUL.Framework</emphasis> inside your APP file. It should look something like this:</para>
							<figure>
								<title>Example of APP file framework</title>
								<screen>
								* Evergreen.app/
								__* Contents/
								____* Frameworks/
								______* XUL.Framework/
								______* Versions/
								________* Current -> 1.9.1.3 (symlink)
								________* 1.9.1.3/
								______* XUL -> Versions/Current/XUL
								______* libxpcom.dylib -> Versions/Current/libxpcom.dylib
								______* xulrunner-bin -> Versions/Current/xulrunner-bin
								</screen>
							</figure>
						</step>
						<step>Copy <emphasis>XUL.Framework/Versions/Current/xulrunner</emphasis> into <emphasis>Evergreen.app/MacOS</emphasis> (do not symlink; copy the file).</step>
						<step>
							<para>Make <emphasis>Evergreen.app/Resources</emphasis> the root of your Evergreen application files like this:</para>
							<figure>
								<title>Example APP file</title>
								<screen>
								* Evergreen.app/
								__* Contents/
								____* Resources/
								______* BUILD_ID
								______* application.ini
								______* chrome/
								______* components/
								______* etc.
								</screen>
							</figure>
						</step>
						<step>Put a <systemitem class="osname">Mac</systemitem> format icon file named <emphasis>Evergreen.icns</emphasis> in Resources.</step>
					</procedure>
				</section>
			</section>
			<section xml:id="serversideinstallation-staffclient">
				<title>Installing on <systemitem class="osname">Linux</systemitem></title>
				<section>
					<title>Quick Upgrade of the Staff Client</title>
					<para>A <systemitem class="osname">Linux</systemitem> Staff Client is automatically built on the server as part of the normal <emphasis>make install</emphasis> process for Evergreen server-side software. To upgrade the Staff Client on a remote workstation with a new version, just copy the directory tree containing the Staff Client from the server to the remote workstation.</para>
					<para>The following example assumes you already have an <systemitem class="username">opensrf</systemitem> user account on both the server and the remote workstation. Remember to replace <literal>user</literal>, <literal>client.linux.machine</literal> and <literal>eg-client-x.x.x.x</literal> with the proper user name, client machine name, and version number in the following example.</para>
					<para>As the <systemitem class="username">opensrf</systemitem> user, change directory to the Staff Client source directory, then recursively copy the entire directory tree to the remote workstation:</para>
					<figure>
						<title>Copying the Staff Client to a remote workstation</title>
						<screen>
						$ su - opensrf
						$ cd /home/opensrf/Evergreen-ILS-1.6.0.7/Open-ILS/xul/staff_client
						$ scp -r build user@client.linux.machine:~/eg-client-x.x.x.x/
						</screen>
					</figure>
					<para>To test the newly copied Staff Client, as the <systemitem class="username">opensrf</systemitem> user log into the remote workstation and execute it as shown:</para>
					<figure>
						<title>Testing the copied Staff Client</title>
						<screen>
						$ su - opensrf
						$ xulrunner ~/eg-client-x.x.x.x/build/application.ini
						</screen>
					</figure>
				</section>
				<section>
					<title>Building the Staff Client on the Server</title>
					<para>A <systemitem class="osname">Linux</systemitem> Staff Client is automatically built on the server as part of the normal <emphasis>make install</emphasis> process for Evergreen server-side software.</para>
					<para>In order to install a compatible Staff Client on another <systemitem class="osname">Linux</systemitem> system, just copy the applicable files from the server to that system, or even manually build it on that system. Ensure that the BUILD_ID you choose on the server matches the BUILD_ID for each staff client you use on other systems.</para>
					<para>If you will be using a pre-packaged <systemitem class="osname">Windows</systemitem> version on some systems, you may want to choose the BUILD_ID on both server and other versions to match that of the <systemitem class="osname">Windows</systemitem> Staff Client. To determine which BUILD_ID is used in an existing Staff Client installation, just click <guibutton>About this Client</guibutton> on the running Staff Client.</para>
					<para>If you are allowed to make changes on the Evergreen server, another option is to create a symbolic link. In order for a copy of the Staff Client and server to work together, the BUILD_ID must match the name of the directory containing the server components of the Staff Client, or the name of a symbolic link to that directory.</para>
					<figure>
						<title>Creating a symbolic link</title>
						<screen>
						$ su - root
						$ cd /openils/var/web/xul
						$ ln -s SERVER_BUILD_ID/ CLIENT_BUILD_ID
						</screen>
					</figure>
				</section>
				<section>
					<title>Building the Staff Client on the client Machine</title>
					<para>This section is directed toward end-users who wish to use <systemitem class="osname">Linux</systemitem> rather than <systemitem class="osname">Windows</systemitem> for client machines, but have limited <systemitem class="osname">Linux</systemitem> experience. You can build the Staff Client on a <systemitem class="osname">Linux</systemitem> system without installing the Evergreen Server component. This is a relatively simple process compared to server installation, but does require some command-line work. The following directions are for building Staff Client version 1.2.1.4 on <systemitem class="osname">Kubuntu 7.10</systemitem>; you must modify them for other distributions (the instructions should work as-is for <systemitem class="osname">Ubuntu</systemitem> or <systemitem class="osname">Ubuntu</systemitem> derivatives).</para>
					<procedure>
						<step>
							<para>Prerequisites</para>
							<para>Both <application>subversion</application> and <application>xulrunner</application> are required to build the Staff Client. As the <systemitem class="username">root</systemitem> user, use <application>apt-get</application> to install packages for <application>subversion</application> and <application>xulrunner</application>. You can also use <application>synaptic</application>, the graphical user interface for <application>apt-get</application>. For <application>subversion</application>, select the latest version; for <application>xulrunner</application>, select version <emphasis>1.8.1.4-2ubuntu5</emphasis>.</para>
							<figure>
								<title>Installing subversion and xulrunner</title>
								<screen>
								$ sudo apt-get install subversion
								$ sudo apt-get install xulrunner
								</screen>
							</figure>
						</step>
						<step>
							<para>Download the Source Code</para>
							<itemizedlist>
								<listitem>
									<para>Determine which version is needed</para>
									<para>For most end-users, a specific version is required to communicate properly with the Evergreen server. Check with your system admininstrator, IT person, or HelpDesk to determine which Staff Client versions are supported.</para>
									<para>Next, you need to determine which <emphasis>tag</emphasis> to use when downloading the source code. Tags are markers in the source code to create a snapshot of the code as it existed at a certain time; tags usually point to tested and stable code, or at least a community-recognized release version.</para>
									<para>To determine which tag to use, browse to <ulink url="http://svn.open-ils.org/trac/ILS/browser">http://svn.open-ils.org/trac/ILS/browser</ulink>. Look in the <guibutton>Visit</guibutton> drop-down box; see the list of Branches and, further down, a list of Tags. You may have to do some guesswork, but it is fairly straightforward to determine which tag to use. If the server is version 1.2.1.4, you will want to use the tag that looks most appropriate. For example, as you look through the tag list, notice the tag named 'rel_1_2_1_4'. This is the tag you need; make a note of it for the next step.</para>
								</listitem>
								<listitem>
									<para>Download the Code</para>
									<para>As the <systemitem class="username">opensrf</systemitem> user, open a terminal (command-line prompt) and navigate to the directory in which you wish to download the Staff Client. Use the following commands to download the proper version of the source code by tag name:</para>
									<figure>
										<title>Downloading the source code</title>
										<screen>
										$ su - opensrf
										$ cd /YOUR/DOWNLOAD/DIRECTORY
										$ svn co svn://svn.open-ils.org/ILS/tags/rel_1_2_1_4/
										</screen>
									</figure>
									<para>Remember to change <literal>rel_1_2_1_4</literal> to the appropriate tag for your installation.</para>
								</listitem>
							</itemizedlist>
						</step>
						<step>
							<para>Build the Staff Client</para>
							<section>
								<title>Evergreen 1.2.x</title>
								<para>In the following example, navigate to the directory in which the source code was downloaded, then navigate to the proper subdirectory and run the <command>make</command> utility to actually build the Staff Client. Remember to check with your system administrator about which Staff Client BUILD_ID to use. The server checks the Staff Client BUILD_ID against itself to determine whether or not a connecting client is supported. For instance, for the PINES installation (version 1.2.1.4) the supported BUILD_ID is <literal>rel_1_2_1_4</literal>. Modify the following commands accordingly.</para>
								<para>As the <systemitem class="username">opensrf</systemitem> user, run the following commands to build the Staff Client:</para>
								<figure>
									<title>Finding the downloaded source code</title>
									<screen>
									$ su - opensrf
									$ cd /YOUR/DOWNLOAD/DIRECTORY
									$ cd Open-ILS/xul/staff_client
									$ make STAFF_CLIENT_BUILD_ID='rel_1_2_1_4'
									...
									</screen>
								</figure>
							</section>
							<section>
								<title>Evergreen 1.4.x</title>
								<para>The 1.4 series of Evergreen has complicated the build process for the Staff Client a bit. If you downloaded a .tar.gz (compressed tar archive) of Evergreen, then your steps will resemble the following:</para>
								<caution>FIXME -- Need instructions for getting certain Javascript files from OpenSRF, preferably without actually installing OpenSRF.
</caution>
								<figure>
									<title>Building 1.4.x</title>
									<screen>
									$ su - opensrf
									$ wget http://evergreen-ils.org/downloads/Evergreen-ILS-1.4.0.4.tar.gz
									$ tar xfz Evergreen-ILS-1.4.0.4.tar.gz
									$ cd Evergreen-ILS-1.4.0.4/
									$ ./configure --prefix=/openils --sysconfdir=/openils/conf
									$ cd Open-ILS/xul/staff_client/
									$ make STAFF_CLIENT_BUILD_ID='rel_1_4_0_4' install
									</screen>
								</figure>
								<para/>
								<para>If you're installing from a Subversion checkout:</para>
								<figure>
									<title>Building from a <application>subversion</application> checkout</title>
									<screen>
									$ su - opensrf
									$ svn co svn://svn.open-ils.org/ILS/tags/rel_1_4_0_4/
									$ cd rel_1_4_0_4
									$ ./autogen.sh   # If you downloaded a .tar.gz of Evergreen, you may skip this step
									$ ./configure --prefix=/openils --sysconfdir=/openils/conf
									$ cd Open-ILS/xul/staff_client/
									$ make STAFF_CLIENT_BUILD_ID='rel_1_4_0_4' install
									</screen>
								</figure>
							</section>
						</step>
						<step>
							<para>Run the Staff Client (from the command line)</para>
							<para>As the <systemitem class="username">opensrf</systemitem> user, navigate to the directory <filename class="directory">build/</filename> (not <filename class="directory">staff_client/</filename>) and run the following command:</para>
							<figure>
								<title>Running the Staff Client</title>
								<screen>
								$ su - opensrf
								$ xulrunner application.ini
								</screen>
							</figure>
						</step>
						<step>
							<para>(OPTIONAL) Cleaning Up / Creating Shortcuts</para>
							<para>The source code download included many files that are needed to build the Staff Client, but are not necessary to run it. You may wish to remove them to save space, or to create a clean directory containing the built staff client that can be copied to other machines. To create a clean "staging" directory in which to place the finished staff client, issue the following commands:</para>
							<figure>
								<title>Creating a "staging" directory</title>
								<screen>
								$ mkdir ~/&lt;Destination Directory>
								$ cd ~/&lt;Download Directory>/Open-ILS/xul/
								$ cp -r staff_client ~/&lt;Destination Directory>
								</screen>
							</figure>
							<para>Finally, test the Staff Client to verify that all the necessary files were moved to the destination directory:</para>
							<figure>
								<title>Testing the copied Staff Client</title>
								<screen>
								$ cd ~/&lt;Destination Directory>/staff_client/build
								$ xulrunner application.ini
								</screen>
							</figure>
							<para>If there were no problems, then finish the cleanup by removing the original download directory and all subdirectories:</para>
							<figure>
								<title>Cleaning up</title>
								<screen>
								$ rm -r -f ~/&lt;Download Directory>
								</screen>
							</figure>
							<para>Finally, test the copied Staff Client. You can create "Desktop / Start Menu / K-Menu" shortcuts for the Staff Client by using the following command as the target:</para>
							<figure>
								<title>Running the copied Staff Client</title>
								<screen>
								$ xulrunner ~/&lt;Destination Directory>/staff_client/build/application.ini
								</screen>
							</figure>
						</step>
					</procedure>
				</section>
				<section>
					<title>Using <application>Wine</application> to Install On Linux</title>
					<para>The <systemitem class="osname">Linux</systemitem> application <application>Wine</application> is another alternative for those who wish to install the packaged <systemitem class="osname">Windows</systemitem> versions rather than building the Staff Client manually. <application>Wine</application> is a <systemitem class="osname">Linux</systemitem> application that allows users to directly run <systemitem class="osname">Windows</systemitem> executables, and is a simple way for casual <systemitem class="osname">Linux</systemitem> users to use the Staff Client. More information about <application>Wine</application> can be found at <ulink url="http://www.winehq.org/site/docs/wineusr-guide/getting-wine">http://www.winehq.org/site/docs/wineusr-guide/getting-wine</ulink>.</para>
					<para>As the <systemitem class="username">root</systemitem> user, use <application>apt-get</application> to install the package for <application>Wine</application>. You can also use <application>synaptic</application>, the graphical user interface.</para>
					<procedure>
						<step>
							<para>Install <application>Wine</application></para>
							<figure>
								<title>Installing <application>Wine</application></title>
								<screen>
								$ sudo apt-get install wine
								</screen>
							</figure>
						</step>
						<step>
							<para>Download <systemitem class="osname">Windows</systemitem> installer for the Staff Client</para>
							<para>As the <systemitem class="username">opensrf</systemitem> user, run the following commands to download the <systemitem class="osname">Windows</systemitem> installer for the proper Staff Client from the <emphasis>open-ils.org</emphasis> website and place it in a temporary directory:</para>
							<figure>
								<title>Downloading the Staff Client installer</title>
								<screen>
								$ su - opensrf
								$ cd /YOUR/DOWNLOAD/DIRECTORY
								$ wget http://open-ils.org/downloads/evergreen-setup-rel_version-number.exe
								</screen>
							</figure>
						</step>
						<step>
							<para>Run the downloaded <systemitem class="osname">Windows</systemitem> installer</para>
							<para>As the <systemitem class="username">opensrf</systemitem> user, navigate to the directory where you downloaded the <systemitem class="osname">Windows</systemitem> executable file, then execute it:</para>
							<figure>
								<title>Using Wine to run the <systemitem class="osname">Windows</systemitem> installer</title>
								<screen>
								$ su - opensrf
								$ cd /YOUR/DOWNLOAD/DIRECTORY
								$ wine evergreen-setup-rel_version-number.exe
								</screen>
							</figure>
							<para>If this step fails, you may need to configure Wine first to properly emulate <systemitem class="osname">WindowsXP</systemitem>. To do so, type the command <command>winecfg</command> from the command line; in the <guibutton>Applications</guibutton> tab of the window that pops up, select <guibutton>Default Settings</guibutton> and choose <guibutton>Windows XP</guibutton> from the drop-down menu, then click <guibutton>Apply</guibutton>.</para>
						</step>
						<step>
							<para>Launch the Staff Client</para>
							<para>A new entry for the Staff Client should now appear somewhere in the <guibutton>All Applications</guibutton> menu of your <systemitem class="osname">Linux</systemitem> desktop. Also, find a new desktop shortcut for the Staff Client. To launch the Staff Client, visit the <guibutton>All Applications</guibutton> menu, find a section similar to <emphasis><menuchoice><guimenu>Wine</guimenu><guimenuitem>Program Files</guimenuitem><guimenuitem>Evergreen Staff Client</guimenuitem><guimenuitem>Evergreen Staff Client</guimenuitem></menuchoice></emphasis>
, or else launch the Staff Client from the desktop shortcut.</para>
						</step>
					</procedure>
				</section>
				<section>
					<title>Running the Staff Client over an SSH Tunnel</title>
					<para>The Staff Client can use an SSH tunnel as a SOCKS 5 proxy. For more details, see <xref linkend="serversideinstallation-proxy"/>.</para>
				</section>
			</section>
			<section xml:id="serversideinstallation-workstationnames">
				<title>Assigning Workstation Names</title>
				<para>The Staff Client must be assigned to a library and given a unique name before it will connect fully to the Evergreen server. The only restriction is that the workstation's name must be unique within the assigned library. Make sure to select a workstation name that you will remember later, and reflects the role, purpose, and/or location of a particular computer. These names will come up later in statistical reporting, and can also be handy when troubleshooting.</para>
				<figure>
					<title>Example of unconfigured Staff Client</title>
					<mediaobject>
						<imageobject>
							<imagedata fileref="../media/serversideinstallation-staffclient-workstationnames-1.png" scalefit="1" width="70%"/>
						</imageobject>
					</mediaobject>
				</figure>
				<para>In order to assign a workstation a name, a user with appropriate permissions must login to the Staff Client. In PINES, the local system administrator (OPSM) has the ability to assign workstation names in his or her library system. Library managers (LIBM's) have the ability within their branch. To assign a workstation a name, login to the system. You will be prompted to assign the workstation a library and a name:</para>
				<figure>
					<title>Example of configured Staff Client</title>
					<mediaobject>
						<imageobject>
							<imagedata fileref="../media/serversideinstallation-staffclient-workstationnames-2.png" scalefit="1" width="70%"/>
						</imageobject>
					</mediaobject>
				</figure>
				<para>Select the library this workstation physically operates in from the drop down menu. In this example, we have selected <literal>MGRL-MA</literal>. Type in a friendly name for the workstation. In this example, we are installing the Staff Client on the director's personal system, and have named it as such. Then hit <emphasis role="bold">Register</emphasis>.</para>
				<para>Once you have registered your workstation with the server, your screen will look like this:</para>
				<figure>
					<title>Example of registered Staff Client</title>
					<mediaobject>
						<imageobject>
							<imagedata fileref="../media/serversideinstallation-staffclient-workstationnames-3.png" scalefit="1" width="70%"/>
						</imageobject>
					</mediaobject>
				</figure>
				<para>You are now ready to log into the Staff Client for the first time. Type in your password again, and hit <emphasis role="bold">Login</emphasis>.</para>
			</section>
		</section>
		<section xml:id="serversideinstallation-building-staffclient">
			<title>Manually Building the Staff Client</title>
			<para>This section reviews the process of manually building the Staff Client in various environments.</para>
			<para>The Staff Client is automatically built by default as part of the normal <emphasis>make install</emphasis> process for Evergreen server-side software. See <xref linkend="serversideinstallation-compilingevergreen"/> to review details related to building the Staff Client in the final compile/link/install phase of the default Evergreen build process.</para>
			<section>
				<title>Building the Staff Client</title>
				<para>You can also manually build the Staff Client by using the <command>make</command> utility in the Staff Client source directory (e.g., the directory <filename class="directory">/home/opensrf/Evergreen-ILS-1.6.0.x/Open-ILS/xul/staff_client</filename> for the current Evergreen version). There are a number of possible options to manually build special versions of the Staff Client on a <systemitem class="osname">Linux</systemitem> system. Following is a list of environment variables that can be passed to <command>make</command> to influence the manual build process:</para>
				<section>
					<title>Option STAFF_CLIENT_BUILD_ID</title>
					<para>During the normal <emphasis>make install</emphasis> Evergreen server-side software build process, the variable defaults to an automatically generated date/time string, but you can also override the value of BUILD_ID.</para>
					<para>The following commands could be used during the normal build process:</para>
					<figure>
						<title>Commands used during normal Evergreen build</title>
						<screen>
						$ su - root
						$ cd /home/opensrf/Evergreen-ILS-1.6.0.7
						$ make STAFF_CLIENT_BUILD_ID=rel_1_6_0_7 install
						...
						</screen>
					</figure>
					<para>The following commands will manually build the Staff Client using a different BUILD_ID.</para>
					<para>As the <systemitem class="username">opensrf</systemitem> user, change directory to the Staff Client source directory, then set the variable and build the Staff Client:</para>
					<figure>
						<title>Commands to manually build the Staff Client</title>
						<screen>
						$ su - opensrf
						$ cd /home/opensrf/Evergreen-ILS-1.6.0.7/Open-ILS/xul/staff_client
						$ make STAFF_CLIENT_BUILD_ID=my_test_id  build
						...
						</screen>
					</figure>
				</section>
				<section>
					<title>Option STAFF_CLIENT_VERSION</title>
					<para>During the normal <emphasis>make install</emphasis> Evergreen server-side software build process, the variable is pulled automatically from a README file in the Evergreen source root. The variable defaults to <emphasis>0trunk.revision</emphasis>, where the value of <literal>revision</literal> is automatically generated. You can override the value of VERSION similarly to the BUILD_ID.</para>
					<para>The following commands could be used during the normal build process:</para>
					<figure>
						<title>Commands used during normal Evergreen build</title>
						<screen>
						$ su - root
						$ cd /home/opensrf/Evergreen-ILS-1.6.0.7
						$ make STAFF_CLIENT_VERSION=0mytest.200 install
						...
						</screen>
					</figure>
					<para>The following commands will manually build the Staff Client using a different VERSION.</para>
					<para>If you plan to make extensions update automatically, the VERSION needs to conform to the format recommended in <ulink url="https://developer.mozilla.org/en/Toolkit_version_format">Toolkit Version Format</ulink> and newer versions need to be "higher" than older versions.</para>
					<para>As the <systemitem class="username">opensrf</systemitem> user, change directory to the Staff Client source directory, then set the variable and build the Staff Client:</para>
					<figure>
						<title>Commands to manually build the Staff Client</title>
						<screen>
						$ su - opensrf
						$ cd /home/opensrf/Evergreen-ILS-1.6.0.7/Open-ILS/xul/staff_client
						$ make STAFF_CLIENT_VERSION=0mytest.200  build
						...
						</screen>
					</figure>
				</section>
				<section>
					<title>Option STAFF_CLIENT_STAMP_ID variable</title>
					<para>During the normal <emphasis>make install</emphasis> Evergreen server-side software build process, this variable is generated from STAFF_CLIENT_VERSION. You can override the value of STAMP_ID similarly to the BUILD_ID.</para>
					<para>The following commands could be used during the normal build process:</para>
					<figure>
						<title>Commands used during normal Evergreen build</title>
						<screen>
						$ su - root
						$ cd /home/opensrf/Evergreen-ILS-1.6.0.7
						$ make STAFF_CLIENT_STAMP_ID=my_test_stamp install
						...
						</screen>
					</figure>
					<para>The following commands will manually build the Staff Client using a different STAMP_ID.</para>
					<para>It is possible to have multiple versions of the Staff Client by specifying a different STAMP_ID for each, possibly for different uses or client-side customizations.</para>
					<para>As the <systemitem class="username">opensrf</systemitem> user, change directory to the Staff Client source directory, then set the variable and build the Staff Client:</para>
					<figure>
						<title>Commands to manually build the Staff Client</title>
						<screen>
						$ su - opensrf
						$ cd /home/opensrf/Evergreen-ILS-1.6.0.7/Open-ILS/xul/staff_client
						$ make STAFF_CLIENT_STAMP_ID=my_test_stamp  build
						...
						</screen>
					</figure>
				</section>
			</section>
			<section>
				<title>Advanced Build Options</title>
				<para>In addition to the basic options listed above, there are a number of advanced options for building the Staff Client. Most are target names for the <command>make</command> utility and require that you build the Staff Client from its source directory. See the following table for a list of possible <command>make</command> target keywords:</para>
				<table>
					<title>Keywords Targets for <application>make</application> Command</title>
					<tgroup align="left" cols="2" colsep="1" rowsep="1">
						<colspec colnum="1" colwidth="1*"/>
						<colspec colnum="2" colwidth="3*"/>
						<thead>
							<row>
								<entry>Keyword</entry>
								<entry>Description</entry>
							</row>
						</thead>
						<tbody>
							<row>
								<entry>clients</entry>
								<entry>Runs "make win-client", "make linux-client", and "make generic-client" individually</entry>
							</row>
							<row>
								<entry>client_dir</entry>
								<entry>Builds a client directory from the build directory, without doing a rebuild. The same as "copy everything but server/".</entry>
							</row>
							<row>
								<entry>client_app</entry>
								<entry>Prerequisite "client_dir"; removes "install.rdf" from client directory so an APP bundle can't be installed as an extension</entry>
							</row>
							<row>
								<entry>client_ext</entry>
								<entry>Prerequisite "client_dir"; remove "application.ini", "autoupdate.js", "standalone_xul_app.js" from client directory so an extension won't break Firefox</entry>
							</row>
							<row>
								<entry>extension</entry>
								<entry>Prerequisite "client_ext"; rewritten to use "client_ext"</entry>
							</row>
							<row>
								<entry>generic-client</entry>
								<entry>Prerequisite "client_app"; makes an XPI file suitable for use with "xulrunner --install-app""</entry>
							</row>
							<row>
								<entry>win-xulrunner</entry>
								<entry>Prerequisite "client_app"; adds Windows xulrunner to client build</entry>
							</row>
							<row>
								<entry>linux-xulrunner</entry>
								<entry>Prerequisite "client_app"; adds Linux xulrunner to client build</entry>
							</row>
							<row>
								<entry>win-client</entry>
								<entry>Prerequisite "win-xulrunner"; builds "setup exe" (requires that "nsis" package be installed, will add options for automatic update if configured and developer options if client build was a "make devbuild")</entry>
							</row>
							<row>
								<entry>linux-client</entry>
								<entry>Prerequisite "linux_xulrunner"; builds a "tar.bz2" bundle of the Linux client</entry>
							</row>
							<row>
								<entry>[generic-|win-|linux-|extension-]updates[-client]</entry>
								<entry>Calls external/make_updates.sh to build full and partial updates generic/win/linux/extension prefix limit to that distribution; Adding the string "-client" builds clients and copies them to a subdirectory of the directory <filename class="directory">updates</filename> as well; the target "extension-updates-client" doesn't exist.</entry>
							</row>
						</tbody>
					</tgroup>
				</table>
				<para>Descriptions of other special build options follow:</para>
				<itemizedlist>
					<listitem>
						<para>Developer Build</para>
						<para>You can create a so-called "developer build" of the Staff Client by substituting <literal>devbuild</literal> for <literal>build</literal> when running <command>make</command>. The build will contain an extra configuration file that enables some developer options.</para>
						<para>As the <systemitem class="username">opensrf</systemitem> user, run <command>make</command> from the Staff Client source directory:</para>
						<figure>
							<title>Commands to do a "developer build"</title>
							<screen>
							$ su - opensrf
							$ cd /home/opensrf/Evergreen-ILS-1.6.0.7/Open-ILS/xul/staff_client
							$ make devbuild
							...
							</screen>
						</figure>
					</listitem>
					<listitem>
						<para>Compressed Javascript</para>
						<para>You can execute the Google application <application>Closure Compiler</application> to automatically review and compress Javascript code after the build process completes, by substituting <literal>compress-javascript</literal> for <literal>build</literal> when running <command>make</command>. For more information see <ulink url="http://code.google.com/closure/compiler/">Google "Closure Compiler"</ulink>.</para>
						<para>As the <systemitem class="username">opensrf</systemitem> user, run the following commands from the Staff Client source directory:</para>
						<figure>
							<title>Commands to compress Javascript</title>
							<screen>
							$ su - opensrf
							$ cd /home/opensrf/Evergreen-ILS-1.6.0.7/Open-ILS/xul/staff_client
							$ make compress-javascript
							...
							</screen>
						</figure>
						<para>You can also combine Javascript review and compression, and also perform a "developer build".</para>
						<para>As the <systemitem class="username">opensrf</systemitem> user, run the following commands from the Staff Client source directory:</para>
						<figure>
							<title>Commands to compress Javascript and do a "developer build"</title>
							<screen>
							$ su - opensrf
							$ cd /home/opensrf/Evergreen-ILS-1.6.0.7/Open-ILS/xul/staff_client
	
							# order of options is important!
							$ make  devbuild  compress-javascript
							...
							</screen>
						</figure>
					</listitem>
					<listitem>
						<para>Automatic Update Host</para>
						<para>The host used to check for automatic Staff Client updates can be overridden by specifying the AUTOUPDATE_HOST option. The following commands could have been used during the normal build process:</para>
						<figure>
							<title>Commands to set AUTOUPDATE_HOST for normal Evergreen build</title>
							<screen>
							$ su - root
							$ cd /home/opensrf/Evergreen-ILS-1.6.0.7
							$ make AUTOUPDATE_HOST=localhost install
							...
							</screen>
						</figure>
						<para>You can manually set AUTOUPDATE_HOST to set up automatic update checking. The following commands will manually build the Staff Client using a different AUTOUPDATE_HOST.</para>
						<para>As the <systemitem class="username">opensrf</systemitem> user, change directory to the Staff Client source directory, then set the variable and build the Staff Client:</para>
						<figure>
							<title>Commands to manually specify AUTOUPDATE_HOST</title>
							<screen>
							$ su - opensrf
							$ cd /home/opensrf/Evergreen-ILS-1.6.0.7/Open-ILS/xul/staff_client
							$ make AUTOUPDATE_HOST=localhost build
							...
							</screen>
						</figure>
						<para>For more information on Automatic Updates, see <xref linkend="serversideinstallation-staffclient-autoupdate"/>.</para>
					</listitem>
				</itemizedlist>
			</section>
			<section>
				<title>Installing and Activating a Manually Built Staff Client</title>
				<para>The Staff Client is automatically built, installed and activated as part of the normal <emphasis>make install</emphasis> process for Evergreen server-side software. However, if you manually build the Staff Client, then you need to take additional steps to properly install and activate it. You also have the option of installing the Staff Client on the same machine it was built on, or on a different machine.</para>
				<para>Assuming you have already built the Staff Client, and that your installation is in the directory <filename class="directory">/openils/var/web/xul</filename>, as the <systemitem class="username">opensrf</systemitem> user, change directory to the Staff Client source directory, then execute the following commands:</para>
				<figure>
					<title>Commands to install the Staff Client on the same machine</title>
					<screen>
					$ su - opensrf
					$ cd /home/opensrf/Evergreen-ILS-1.6.0.7/Open-ILS/xul/staff_client
					$ mkdir -p "/openils/var/web/xul/$(cat build/BUILD_ID)"
					$ cp -R build/server "/openils/var/web/xul/$(cat build/BUILD_ID)"
					</screen>
				</figure>
			</section>
			<section>
				<title>Packaging the Staff Client</title>
				<para>Once the Staff Client has been built, you can create several forms of client packages by using some targetted <command>make</command> commands in the Staff Client source directory.</para>
				<itemizedlist>
					<listitem>
						<para>Packaging a Generic Client</para>
						<para>This build creates a Staff Client packaged as an XPI file to use with <emphasis>XULRunner</emphasis>. It requires that you already have the <application>zip</application> utility installed on your system. It will create the output file <filename>evergreen_staff_client.xpi</filename>, suitable for use with the <emphasis>XULRunner</emphasis> option <option>--install-app</option>.</para>
						<para>As the <systemitem class="username">opensrf</systemitem> user, change directory to the Staff Client source directory, then execute the following commands:</para>
						<figure>
							<title>Commands to package a "generic" client</title>
							<screen>
							$ su - opensrf
							$ cd /home/opensrf/Evergreen-ILS-1.6.0.7/Open-ILS/xul/staff_client
							$ make generic-client
							...
							</screen>
						</figure>
					</listitem>
					<listitem>
						<para>Packaging a <systemitem class="osname">Windows</systemitem> Client</para>
						<para>This build creates a Staff Client packaged as a <systemitem class="osname">Windows</systemitem> executable. It requires that you already have the <application>unzip</application> utility installed on your system. It also requires that you install <ulink url="http://nsis.sourceforge.net/">NSIS (Nullsoft Scriptable Install System)</ulink>, a professional open source utility package used to create <systemitem class="osname">Windows</systemitem> installers (the <application>makensis</application> utility is installed as part of the <application>nsis</application> package). We recommend using Version 2.45 or later. This build will create the output file <filename>evergreen_staff_client_setup.exe</filename>.</para>
						<para>(OPTIONAL) If you wish for the Staff Client to have a link icon/tray icon by default, you may wish to provide a pre-modified <filename>xulrunner-stub.exe</filename>. Place it in the Staff Client source directory and <application>make</application> will automatically use it instead of the one that comes with the downloaded <emphasis>XULRunner</emphasis> release. The version of <filename>xulrunner-stub.exe</filename> need not match exactly.</para>
						<para>(OPTIONAL) You can also use a tool such as <ulink url="http://www.angusj.com/resourcehacker/">Resource Hacker</ulink> to embed icons. <application>Resource Hacker</application> is an open-source utility used to view, modify, rename, add, delete and extract resources in 32bit <systemitem class="osname">Windows</systemitem> executables. See the following table for some useful icon ID strings:</para>
						<table>
							<title>Useful icon ID strings</title>
							<tgroup align="left" cols="2" colsep="1" rowsep="1">
								<colspec colnum="1" colwidth="1*"/>
								<colspec colnum="2" colwidth="1*"/>
								<tbody>
									<row>
										<entry>IDI_APPICON</entry>
										<entry>Tray icon</entry>
									</row>
									<row>
										<entry>32512</entry>
										<entry>Default window icon</entry>
									</row>
								</tbody>
							</tgroup>
						</table>
						<para>As the <systemitem class="username">opensrf</systemitem> user, change directory to the Staff Client source directory, then execute the following commands:</para>
						<figure>
							<title>Commands to build a <systemitem class="osname">Windows</systemitem> client</title>
							<screen>
							$ su - opensrf
							$ cd /home/opensrf/Evergreen-ILS-1.6.0.7/Open-ILS/xul/staff_client
							$ make win-client
							...
							</screen>
						</figure>
					</listitem>
					<listitem>
						<para>Packaging a <systemitem class="osname">Linux</systemitem> Client</para>
						<para>This build creates a Staff Client package for <systemitem class="osname">Linux</systemitem> as a "tar.bz2" file with <emphasis>XULRunner</emphasis> already bundled with it. It creates the output file <filename>evergreen_staff_client.tar.bz2</filename>.</para>
						<para>As the <systemitem class="username">opensrf</systemitem> user, change directory to the Staff Client source directory, then execute the following commands:</para>
						<figure>
							<title>Commands to build a <systemitem class="osname">Linux</systemitem> client</title>
							<screen>
							$ su - opensrf
							$ cd /home/opensrf/Evergreen-ILS-1.6.0.7/Open-ILS/xul/staff_client
							$ make linux-client
							...
							</screen>
						</figure>
					</listitem>
					<listitem>
						<para>Packaging a Firefox Extension</para>
						<para>This build requires that you already have the <application>zip</application> utility installed on your system. It creates a Staff Client packaged as a Firefox extension and creates the output file <filename>evergreen.xpi</filename>.</para>
						<para>As the <systemitem class="username">opensrf</systemitem> user, change directory to the Staff Client source directory, then execute the following commands:</para>
						<figure>
							<title>Commands to build a Firefox extension</title>
							<screen>
							$ su - opensrf
							$ cd /home/opensrf/Evergreen-ILS-1.6.0.7/Open-ILS/xul/staff_client
							$ make extension
							...
							</screen>
						</figure>
					</listitem>
				</itemizedlist>
			</section>
			<section xml:id="serversideinstallation-staffclient-autoupdate">
				<title>Staff Client Automatic Updates</title>
				<para>It is possible to set up support for automatic Staff Client updates, either during the normal Evergreen server-side build process, or by manually building the Staff Client with certain special options.</para>
				<section>
					<title>WARNINGS</title>
					<para>Automatic update server certificate requirements are more strict than normal server requirements. Firefox and <emphasis>XULRunner</emphasis> will both ignore any automatic update server that is not validated by a trusted certificate authority. Servers with exceptions added to force the Staff Client to accept them <emphasis>WILL NOT WORK</emphasis>.</para>
					<para>In addition, automatic updates have special requirements for the file <filename>update.rdf</filename>:</para>
					<orderedlist>
						<listitem>It must be served from an SSL server, or</listitem>
						<listitem>It must be signed with the <ulink url="https://developer.mozilla.org/en/McCoy">McCoy</ulink> tool.</listitem>
					</orderedlist>
					<para>You can pre-install the signing key into the file <filename>install.rdf</filename> directly, or install it into a copy as <emphasis>install.mccoy.rdf</emphasis>. If the latter exists it will be copied into the build instead of the original file <filename>install.rdf</filename>.</para>
				</section>
				<section>
					<title>Autoupdate Host</title>
					<para>The name of the automatic update host can be provided in either of two ways:</para>
					<orderedlist>
						<listitem>At configuration time for the normal build of the Evergreen server-side software, or</listitem>
						<listitem>During a manual Staff Client build process.</listitem>
					</orderedlist>
					<para/>
					<itemizedlist>
						<listitem>
							<para>At configuration time for the normal build of Evergreen server-side software</para>
							<para>This must be done when the Evergreen server-side software is first configured (see <xref linkend="serversideinstallation-configure"/>). As the <systemitem class="username">opensrf</systemitem> user, use the <command>configure</command> utility as shown:</para>
							<figure>
								<title>Commands to configure Evergreen</title>
								<screen>
								$ su - opensrf
								$ cd /home/opensrf/Evergreen-ILS-1.6.0.7
								$ ./configure --prefix=/openils --sysconfdir=/openils/conf --with-updateshost=hostname
								$ make
								...
								</screen>
							</figure>
						</listitem>
						<listitem>
							<para>During a manual Staff Client build process</para>
							<para>You will used the variable AUTOUPDATE_HOST=hostname (see above). If you specify just a hostname (such as <uri>example.com</uri>) then the URL will be a secure URL (such as <uri>https://example.com</uri>. If you wish to use a non-HTTPS URL then prefix the hostname with "http://" (such as <uri>http://example.com</uri>).</para>
							<para>If neither option is used then, by default, the Staff Client will not include the automatic update preferences.</para>
						</listitem>
					</itemizedlist>
				</section>
				<section>
					<title>Building Updates</title>
					<para>Similar to building clients, the targets <literal>generic-updates</literal>, <literal>win-updates</literal>, <literal>linux-updates</literal>, and <literal>extension-updates</literal> can be used individually with <command>make</command> to build the update files for the Staff Client. To build all the targets at once, simply use the target <literal>updates</literal>.</para>
					<para>A "full" update will be built for each specified target (or for all if you use the target <literal>updates</literal>). For all but extensions any previous "full" updates (archived by default in the directory <filename class="directory">/openils/var/updates/archives</filename>) will be used to make "partial" updates. Partial updates tend to be much smaller and will thus download more quickly, but if something goes wrong with a partial update the full update will be used as a fallback. Extensions do not currently support partial updates.</para>
					<para>As the <systemitem class="username">opensrf</systemitem> user, change directory to the Staff Client source directory, then execute the following commands:</para>
					<figure>
						<title>Commands for building updates</title>
						<screen>
						$ su - opensrf
						$ cd /home/opensrf/Evergreen-ILS-1.6.0.7/Open-ILS/xul/staff_client
	
						# command to build all updates at once:
						$ make updates
						...
	
						# commands to build updates individually:
						$ make generic-updates
						...
						$ make win-updates
						...
						$ make linux-updates
						...
						$ make extension-updates
						...
						</screen>
					</figure>
				</section>
				<section>
					<title>Building updates with clients</title>
					<para>To save time and effort you can build updates and manual download clients at the same time by adding the string "-client" to each target name. For instance, you can specify <literal>win-updates-client</literal>. You can also specify <literal>updates-client</literal> to build all the targets at once. This does not work for extension-updates.</para>
					<para>The clients will be installed alongside the updates and listed on the web page <uri>manualupdate.html</uri>, rather than left in the Staff Client directory.</para>
					<para>As the <systemitem class="username">opensrf</systemitem> user, change directory to the Staff Client source directory, then execute the following commands:</para>
					<figure>
						<title>Commands for building updates</title>
						<screen>
						$ su - opensrf
						$ cd /home/opensrf/Evergreen-ILS-1.6.0.7/Open-ILS/xul/staff_client
	
						# command to build all updates at once:
						$ make updates-client
						...
	
						# commands to build updates individually:
						$ make generic-updates-client
						...
						$ make win-updates-client
						...
						$ make linux-updates-client
						...
						</screen>
					</figure>
				</section>
				<section>
					<title>Activating the Update Server</title>
					<para>This section reviews scripts associated with the update server, and requires some final adjustments to file permissions.</para>
					<para>The Apache example configuration creates a directory <filename class="directory">updates</filename> that, by default, points to the directory <filename class="directory">/openils/var/updates/pub</filename>. This directory contains one HTML file and several specially-named script files.</para>
					<para>The file <filename>updatedetails.html</filename> is the fallback web page for the update details. The <application>check</application> script is used for <emphasis>XULRunner</emphasis> updates. The <application>update.rdf</application> script is used for extension updates. The <application>manualupdate.html</application> script checks for clients to provide download links when automatic updates have failed and uses the download script to force a download of the generic client XPI (compared to Firefox trying to install it as an extension).</para>
					<para>The following scripts should be marked as executable: <emphasis>check, download, manualupdate.html, update.rdf</emphasis>. As the <systemitem class="username">root</systemitem> user, change directory to the updates directory, then execute the following commands:</para>
					<figure>
						<title>Changing file permissions of scripts</title>
						<screen>
						$ su - root
						$ cd /openils/var/updates/pub
						$ chmod +x  check  download  manualupdate.html  update.rdf
						</screen>
					</figure>
				</section>
			</section>
			<section>
				<title>Other tips</title>
				<section>
					<title>Multiple workstations on one install</title>
					<para>Multiple workstation registrations for the same server can be accomplished with a single Staff Client install by using multiple profiles. When running <emphasis>XULRunner</emphasis> you can specify the option <option>-profilemanager</option> or <option>-P</option> (uppercase "P") to force the Profile Manager to start. Unchecking the option <option>Don't ask at startup</option> will make this the default.</para>
					<para>Once you have opened the Profile Manager you can create additional profiles, one for each workstation you wish to register. You may need to install SSL exceptions for each profile.</para>
					<para>When building targets <literal>win-client</literal>, <literal>win-updates-client</literal>, or <literal>updates-client</literal>, you can specify <literal>NSIS_EXTRAOPTS=-DPROFILES</literal> to add an "Evergreen Staff Client Profile Manager" option to the start menu.</para>
					<para>As the <systemitem class="username">opensrf</systemitem> user, change directory to the Staff Client source directory, then execute the following commands:</para>
					<figure>
						<title>Command to add start menu option</title>
						<screen>
						$ su - opensrf
						$ cd /home/opensrf/Evergreen-ILS-1.6.0.7/Open-ILS/xul/staff_client
						$ make NSIS_EXTRAOPTS=-DPROFILES win-client
						...
						</screen>
					</figure>
				</section>
				<section>
					<title> Multiple Staff Clients</title>
					<para>This may be confusing if you are not careful, but you can log in to multiple Evergreen servers at the same time, or a single Evergreen server multiple times. In either case you will need to create an additional profile for each additional server or workstation you want to log in as (see previous tip).</para>
					<para>Once you have created the profiles, run <emphasis>XULRunner</emphasis> with the option <option>-no-remote</option> (in addition to <option>-profilemanger</option> or <option>-P</option> if neeeded). Instead of <emphasis>XULRunner</emphasis> opening a new login window on your existing session it will start a new session instead, which can then be logged in to a different server or workstation ID.</para>
				</section>
			</section>
		</section>
		<section xml:id="serversideinstallation-running-staffclient">
			<title>Running the Staff Client</title>
			<para>Run the Staff Client on a <systemitem class="osname">Linux</systemitem> system by using the application <emphasis>XULRunner</emphasis> (installed automatically and by default with Firefox version 3.0 and later on <systemitem class="osname">Ubuntu</systemitem> and <systemitem class="osname">Debian</systemitem> distributions).</para>
			<para>For example, if the source files for the Evergreen installation are in the directory <filename class="directory">/home/opensrf/Evergreen-ILS-1.6.0.7/</filename>, start the Staff Client as shown in the following command example:</para>
			<figure>
				<title>Commands to run the Staff Client</title>
				<screen>
				$ su - opensrf
				$ xulrunner /home/opensrf/Evergreen-ILS-1.6.0.7/Open-ILS/xul/staff_client/build/application.ini
				</screen>
			</figure>
		</section>
		<section xml:id="serversideinstallation-proxy">
			<title>Configuring a Proxy for the Staff Client</title>
			<section>
				<title>Why Use a Proxy for the Staff Client?</title>
				<para>There are several reasons for sending network traffic for the Staff Client through an SSH proxy:</para>
				<itemizedlist>
					<listitem>
						<para><emphasis role="bold">Firewalls</emphasis> may prevent you from reaching the server. This may happen when you are connecting the Staff Client to a test server that should not be available generally, or it may be the result of network design priorities other than ease of use.</para>
					</listitem>
					<listitem>
						<para>You may wish to <emphasis role="bold">improve security</emphasis> where Staff Client traffic may be susceptible to network eavesdropping. This is especially true when wireless is otherwise the best option for connecting a staff machine to the network.</para>
					</listitem>
				</itemizedlist>
			</section>
			<section>
				<title>Setting Up an SSH Tunnel</title>
				<para>You will need a server that has network access to the Evergreen server you want to reach, and allows you to log in there via SSH. Use your username and password for that SSH server to set up a tunnel.</para>
				<para>For <systemitem class="osname">Windows</systemitem> users, one good solution is the open-source utility <ulink url="http://www.chiark.greenend.org.uk/~sgtatham/putty/">PuTTY</ulink>, a free telnet/SSH client. An example of setting up a <application>PuTTY</application> session follows:</para>
				<figure>
					<title>Setting up an SSH tunnel in PuTTY</title>
					<mediaobject>
						<imageobject>
							<imagedata fileref="../media/serversideinstallation-proxy-putty.png" scalefit="1" width="70%"/>
						</imageobject>
					</mediaobject>
				</figure>
				<procedure>
					<step>Use the menu on the left to go to <emphasis><menuchoice><guimenu>Connection</guimenu><guimenuitem>SSH</guimenuitem><guimenuitem>Tunnels</guimenuitem></menuchoice></emphasis>.</step>
					<step>Enter <literal>9999</literal> in the "Source port".</step>
					<step>Choose <guibutton>Dynamic</guibutton>. Do not enter anything in the Destination text entry box.</step>
					<step>Click <guibutton>Add</guibutton>. "D9999" will now appear in the "Forwarded ports" list.</step>
					<step>Use the menu on the left to go back to "Session", and enter the host name of the SSH server.</step>
					<step>A window will open up so that you can enter your username and password. Once you are logged in, the tunnel is open.</step>
				</procedure>
			</section>
			<section>
				<title>Configuring the Staff Client to Use the SSH Tunnel</title>
				<para>In order to tell the Staff Client that all traffic should be sent through the SSH tunnel just configured, you must edit the file <filename>C:\Program Files\Evergreen Staff Client\greprefs\all.js</filename>. Search this file for the word <emphasis role="bold">socks</emphasis> to find the appropriate section for the following changes.</para>
				<figure>
					<title>The SOCKS section of <filename>all.js</filename> before changes</title>
					<mediaobject>
						<imageobject>
							<imagedata fileref="../media/serversideinstallation-proxy-socks-1.png" scalefit="1" width="70%"/>
						</imageobject>
					</mediaobject>
				</figure>
				<para>Make the following changes:</para>
				<itemizedlist>
					<listitem>Change the value of <emphasis>network.proxy.socks</emphasis> from <emphasis role="bold">""</emphasis> to <emphasis role="bold">"localhost"</emphasis>.</listitem>
					<listitem>Change the value of <emphasis>network.proxy.socks_port</emphasis> from <emphasis role="bold">"0"</emphasis> to <emphasis role="bold">9999</emphasis>.</listitem>
				</itemizedlist>
				<figure xml:id="serversideinstallation-socks-figure">
					<title>The SOCKS section of <filename>all.js</filename> after changes</title>
					<mediaobject>
						<imageobject>
							<imagedata fileref="../media/serversideinstallation-proxy-socks-2.png" scalefit="1" width="70%"/>
						</imageobject>
					</mediaobject>
				</figure>
				<para>If everything is working correctly, you should now be able to run the Staff Client and all its data will be sent encrypted through the SSH tunnel you have just configured.</para>
			</section>
		</section>
	</section>
	<section xml:id="serversideinstallation-ssl">
		<title>Getting a Signed SSL Certificate</title>
		<para>This section describes how to get a properly signed SSL certificate.</para>
		<para>For temporary testing purposes, you can use the command <command>openssl</command> to create a new SSL key for your Apache server. This is just a self-signed certificate and will generate warnings in the Staff Client and browser during testing and development. For a public production server you should configure or purchase a properly signed SSL certificate.</para>
		<indexterm>
			<primary>ZZZ-REVIEW</primary>
			<secondary>ADD INFO ON HOW TO GET A SIGNED SSL CERTIFICATE </secondary>
		</indexterm>
		<caution>ADD INFO ON HOW TO GET A SIGNED SSL CERTIFICATE </caution>
	</section>
	<index/>
</chapter>
